<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energie-Monitor - STWEG Rosenweg</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .pulse-green {
            animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-green {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-4px);
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-r from-yellow-500 to-orange-600 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <svg class="h-16 w-16 mx-auto text-yellow-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">Energie-Monitor</h1>
                <p class="text-gray-600 mt-2">STWEG-Kooperation Rosenweg</p>
            </div>

            <!-- Email Input -->
            <div id="email-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail-Adresse</label>
                    <input
                        type="email"
                        id="email-input"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                        placeholder="ihre-email@example.com"
                        autocomplete="email"
                    >
                </div>
                <button
                    onclick="sendOTP()"
                    class="w-full bg-yellow-600 text-white py-3 rounded-lg hover:bg-yellow-700 transition font-semibold"
                >
                    Code anfordern
                </button>
            </div>

            <!-- OTP Input -->
            <div id="otp-form" class="hidden space-y-4">
                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                    <p class="text-sm text-green-700">
                        Ein 6-stelliger Code wurde an <strong id="display-email"></strong> gesendet.
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">6-stelliger Code</label>
                    <input
                        type="text"
                        id="otp-input"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center text-2xl tracking-widest"
                        placeholder="000000"
                        maxlength="6"
                        pattern="[0-9]{6}"
                        autocomplete="one-time-code"
                    >
                </div>
                <button
                    onclick="verifyOTP()"
                    class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold"
                >
                    Anmelden
                </button>
                <button
                    onclick="backToEmail()"
                    class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition text-sm"
                >
                    Andere E-Mail verwenden
                </button>
            </div>

            <div id="message" class="mt-4 text-center text-sm"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span class="ml-2 text-xl font-semibold text-gray-800">Energie-Monitor</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-info" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-700 text-sm font-medium">
                            Abmelden
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- Live Status -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Live-Verbrauch</h2>
                    <div class="flex items-center text-green-600">
                        <div class="w-3 h-3 bg-green-600 rounded-full pulse-green mr-2"></div>
                        <span class="text-sm font-medium">Live</span>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Aktuelle Leistung -->
                    <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg shadow-lg p-6 text-white metric-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-yellow-100">Aktuelle Leistung</span>
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="text-4xl font-bold" id="live-power">---</div>
                        <div class="text-sm text-yellow-100 mt-1" id="live-tarif">Lade...</div>
                    </div>

                    <!-- Heutiger Verbrauch -->
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white metric-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-green-100">Heute</span>
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="text-4xl font-bold" id="today-consumption">---</div>
                        <div class="text-sm text-green-100 mt-1" id="today-cost">Kosten: ---</div>
                    </div>

                    <!-- Solar (wenn vorhanden) -->
                    <div id="solar-card" class="hidden bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg shadow-lg p-6 text-white metric-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-yellow-100">Solar</span>
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                        </div>
                        <div class="text-4xl font-bold" id="solar-power">---</div>
                        <div class="text-sm text-yellow-100 mt-1" id="solar-autarkie">Autarkie: ---</div>
                    </div>
                </div>
            </div>

            <!-- Zeitraum-Auswahl -->
            <div class="mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="selectPeriod('day')" class="period-btn px-6 py-2 bg-yellow-600 text-white rounded-lg font-medium hover:bg-yellow-700 transition">
                            Tag
                        </button>
                        <button onclick="selectPeriod('week')" class="period-btn px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition">
                            Woche
                        </button>
                        <button onclick="selectPeriod('month')" class="period-btn px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition">
                            Monat
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid lg:grid-cols-2 gap-6 mb-8">
                <!-- Verbrauchsverlauf -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Verbrauchsverlauf</h3>
                    <canvas id="consumption-chart" height="300"></canvas>
                </div>

                <!-- Tarifaufteilung -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tarifaufteilung</h3>
                    <canvas id="tariff-chart" height="300"></canvas>
                </div>
            </div>

            <!-- Statistik-Tabelle -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Detaillierte Statistik</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Tarif</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700">Verbrauch (kWh)</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700">Preis/kWh</th>
                                <th class="px-4 py-3 text-right font-semibold text-gray-700">Kosten (CHF)</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table" class="divide-y divide-gray-200">
                            <!-- Wird dynamisch gefüllt -->
                        </tbody>
                        <tfoot class="bg-gray-50 font-semibold">
                            <tr>
                                <td class="px-4 py-3 text-left">Gesamt</td>
                                <td class="px-4 py-3 text-right" id="total-consumption">---</td>
                                <td class="px-4 py-3 text-right">---</td>
                                <td class="px-4 py-3 text-right" id="total-cost">---</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Unterzähler (wenn vorhanden) -->
            <div id="submeters-section" class="hidden mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Unterzähler</h3>
                <div id="submeters-grid" class="grid md:grid-cols-3 gap-4">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // Globale Variablen
        let currentUser = null;
        let currentPeriod = 'day';
        let zaehlerConfig = null;
        let benutzerDaten = null;
        let charts = {};
        let liveUpdateInterval = null;

        // Konfiguration laden
        async function loadConfig() {
            try {
                const response = await fetch('zaehler-config.json');
                zaehlerConfig = await response.json();
                console.log('✅ Konfiguration geladen', zaehlerConfig);
            } catch (error) {
                console.error('❌ Fehler beim Laden der Konfiguration:', error);
            }
        }

        // Beim Laden der Seite
        window.addEventListener('DOMContentLoaded', async function() {
            await loadConfig();

            // Auto-Logout nach 1 Stunde
            setTimeout(() => {
                if (currentUser) {
                    alert('Sitzung abgelaufen. Bitte melden Sie sich erneut an.');
                    logout();
                }
            }, 3600000);
        });

        // E-Mail in STWEG kontakte.json Dateien suchen
        async function searchEmailInSTWEGKontakte(email) {
            // Liste der STWEGs (aktuell 1-8, kann erweitert werden)
            const stwegs = [1, 2, 3, 4, 5, 6, 7, 8];

            for (const stwegNr of stwegs) {
                try {
                    const response = await fetch(`stweg${stwegNr}/data/kontakte.json`);
                    if (!response.ok) continue;

                    const kontakte = await response.json();

                    // In Verteilerlisten suchen (alle, bewohner, eigentuemer)
                    const verteilerlisten = kontakte.verteilerlisten || {};
                    for (const [listName, liste] of Object.entries(verteilerlisten)) {
                        for (const person of liste) {
                            // E-Mail kann mehrere Adressen enthalten (komma-separiert)
                            const emails = person.email.split(',').map(e => e.trim().toLowerCase());
                            if (emails.includes(email)) {
                                return {
                                    email: email,
                                    name: person.name,
                                    wohnung: `Rosenweg ${kontakte.stweg.adresse.split(' ')[1]}, ${person.wohnung}`,
                                    stweg: stwegNr
                                };
                            }
                        }
                    }

                    // In Wohnungen suchen (Eigentümer und Mieter)
                    const wohnungen = kontakte.wohnungen || {};
                    for (const [etage, whgListe] of Object.entries(wohnungen)) {
                        for (const wohnung of whgListe) {
                            // Eigentümer prüfen
                            if (wohnung.eigentümer && wohnung.eigentümer.email) {
                                const emails = wohnung.eigentümer.email.split(',').map(e => e.trim().toLowerCase());
                                if (emails.includes(email)) {
                                    return {
                                        email: email,
                                        name: wohnung.eigentümer.name,
                                        wohnung: `Rosenweg ${kontakte.stweg.adresse.split(' ')[1]}, ${wohnung.bezeichnung}`,
                                        stweg: stwegNr
                                    };
                                }
                            }

                            // Mieter prüfen
                            if (wohnung.mieter && wohnung.mieter.email) {
                                const emails = wohnung.mieter.email.split(',').map(e => e.trim().toLowerCase());
                                if (emails.includes(email)) {
                                    return {
                                        email: email,
                                        name: wohnung.mieter.name,
                                        wohnung: `Rosenweg ${kontakte.stweg.adresse.split(' ')[1]}, ${wohnung.bezeichnung}`,
                                        stweg: stwegNr
                                    };
                                }
                            }
                        }
                    }

                } catch (error) {
                    console.log(`STWEG ${stwegNr} kontakte.json nicht gefunden oder Fehler:`, error);
                }
            }

            return null;
        }

        // Benutzer-Eintrag via n8n Webhook erstellen
        async function createUserEntry(userData) {
            try {
                const response = await fetch('https://n8n.juroct.net/webhook/zaehler-benutzer-erstellen', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: userData.email,
                        name: userData.name,
                        wohnung: userData.wohnung,
                        stweg: userData.stweg,
                        zugriff: 'bewohner',
                        zaehler: [], // Leer - muss von Technik zugeordnet werden
                        needs_meter_assignment: true,
                        created_at: new Date().toISOString()
                    })
                });

                return response.ok;
            } catch (error) {
                console.error('Fehler beim Erstellen des Benutzers:', error);
                return false;
            }
        }

        // OTP anfordern
        async function sendOTP() {
            const email = document.getElementById('email-input').value.trim().toLowerCase();

            if (!email || !email.includes('@')) {
                showMessage('Bitte geben Sie eine gültige E-Mail-Adresse ein.', 'error');
                return;
            }

            // Prüfen, ob E-Mail in Config existiert
            let benutzer = zaehlerConfig.benutzer.find(b => b.email.toLowerCase() === email);

            // Wenn nicht gefunden, in STWEG kontakte.json suchen
            if (!benutzer) {
                showMessage('E-Mail wird geprüft...', 'info');
                const foundInKontakte = await searchEmailInSTWEGKontakte(email);

                if (foundInKontakte) {
                    // Benutzer via n8n Webhook erstellen
                    const created = await createUserEntry(foundInKontakte);
                    if (created) {
                        // Konfiguration neu laden
                        await loadConfig();
                        benutzer = zaehlerConfig.benutzer.find(b => b.email.toLowerCase() === email);
                        showMessage('Benutzer wurde angelegt. Zählerzuordnung erfolgt durch Technik-Team.', 'info');
                    } else {
                        showMessage('Fehler beim Anlegen des Benutzers. Bitte kontaktieren Sie das Technik-Team.', 'error');
                        return;
                    }
                } else {
                    showMessage('Diese E-Mail-Adresse ist nicht berechtigt.', 'error');
                    return;
                }
            }

            // OTP-Code generieren (6-stellig)
            const otpCode = Math.floor(100000 + Math.random() * 900000).toString();

            // Code mit Timestamp speichern (10 Minuten gültig)
            const otpData = {
                code: otpCode,
                email: email,
                expires: Date.now() + 600000 // 10 Minuten
            };
            localStorage.setItem('energie_monitor_otp', JSON.stringify(otpData));

            // HTML für E-Mail erstellen
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 20px auto; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #eab308 0%, #f97316 100%); color: white; padding: 30px 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 28px; }
        .content { padding: 30px 20px; }
        .otp-box { background: #fef9c3; border: 2px dashed #eab308; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0; }
        .otp-code { font-size: 36px; font-weight: bold; color: #d97706; letter-spacing: 8px; margin: 10px 0; }
        .info { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 20px 0; border-radius: 4px; }
        .footer { background: #f9fafb; padding: 20px; text-align: center; font-size: 12px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ Energie-Monitor Login</h1>
            <p>STWEG-Kooperation Rosenweg</p>
        </div>
        <div class="content">
            <h2>Ihr Anmelde-Code</h2>
            <p>Verwenden Sie folgenden Code, um sich im Energie-Monitor anzumelden:</p>

            <div class="otp-box">
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">IHR CODE</div>
                <div class="otp-code">${otpCode}</div>
                <div style="color: #6b7280; font-size: 12px; margin-top: 10px;">Gültig für 10 Minuten</div>
            </div>

            <div class="info">
                <strong>⚠️ Wichtig:</strong> Dieser Code ist nur 10 Minuten gültig. Geben Sie ihn niemals an Dritte weiter.
            </div>

            <p>Wenn Sie diese Anfrage nicht gestellt haben, ignorieren Sie diese E-Mail einfach.</p>
        </div>
        <div class="footer">
            <p>STWEG-Kooperation Rosenweg | Kaiseraugst<br>
            Diese E-Mail wurde automatisch generiert.</p>
        </div>
    </div>
</body>
</html>`;

            try {
                const response = await fetch(zaehlerConfig.n8n_webhooks.send_email, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        recipients: [email],
                        subject: 'Ihr Login-Code für den Energie-Monitor',
                        htmlContent: htmlContent,
                        fromEmail: 'noreply@rosenweg4303.ch'
                    })
                });

                if (response.ok) {
                    document.getElementById('display-email').textContent = email;
                    document.getElementById('email-form').classList.add('hidden');
                    document.getElementById('otp-form').classList.remove('hidden');
                    showMessage('Code wurde gesendet!', 'success');
                } else {
                    showMessage('Fehler beim Senden des Codes.', 'error');
                }
            } catch (error) {
                console.error('Fehler:', error);
                showMessage('Netzwerkfehler. Bitte versuchen Sie es erneut.', 'error');
            }
        }

        // OTP verifizieren
        async function verifyOTP() {
            const email = document.getElementById('display-email').textContent;
            const otp = document.getElementById('otp-input').value;

            if (otp.length !== 6) {
                showMessage('Bitte geben Sie einen 6-stelligen Code ein.', 'error');
                return;
            }

            // OTP-Daten aus LocalStorage holen
            const otpDataStr = localStorage.getItem('energie_monitor_otp');
            if (!otpDataStr) {
                showMessage('Kein Code gefunden. Bitte fordern Sie einen neuen Code an.', 'error');
                return;
            }

            const otpData = JSON.parse(otpDataStr);

            // Prüfen ob abgelaufen
            if (Date.now() > otpData.expires) {
                localStorage.removeItem('energie_monitor_otp');
                showMessage('Code abgelaufen. Bitte fordern Sie einen neuen Code an.', 'error');
                backToEmail();
                return;
            }

            // Prüfen ob E-Mail übereinstimmt
            if (otpData.email.toLowerCase() !== email.toLowerCase()) {
                showMessage('E-Mail stimmt nicht überein.', 'error');
                return;
            }

            // Code prüfen
            if (otpData.code !== otp) {
                showMessage('Ungültiger Code. Bitte versuchen Sie es erneut.', 'error');
                return;
            }

            // Code ist korrekt - Benutzer anmelden
            localStorage.removeItem('energie_monitor_otp');
            const benutzer = zaehlerConfig.benutzer.find(b => b.email.toLowerCase() === email.toLowerCase());

            if (benutzer) {
                currentUser = benutzer;
                benutzerDaten = benutzer;
                await showDashboard();
            } else {
                showMessage('Ungültiger Benutzer.', 'error');
            }
        }

        // Dashboard anzeigen
        async function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // Benutzerinfo anzeigen
            document.getElementById('user-info').textContent = `${currentUser.name} (${currentUser.wohnung})`;

            // Solar-Karte anzeigen wenn vorhanden
            const hatSolar = currentUser.zaehler.some(z => z.hat_solar);
            if (hatSolar) {
                document.getElementById('solar-card').classList.remove('hidden');
            }

            // Daten laden
            await loadDashboardData();

            // Live-Updates starten
            startLiveUpdates();
        }

        // Dashboard-Daten laden
        async function loadDashboardData() {
            const heute = new Date().toISOString().split('T')[0];
            const hauptzaehler = currentUser.zaehler.find(z => z.typ === 'hauptzaehler');

            if (!hauptzaehler) {
                console.error('Kein Hauptzähler gefunden');
                return;
            }

            try {
                const response = await fetch(`zaehler-daten/${heute}_${hauptzaehler.id}.json`);
                const daten = await response.json();

                // Live-Werte aktualisieren
                updateLiveValues(daten);

                // Charts aktualisieren
                updateCharts(daten);

                // Statistik aktualisieren
                updateStatistics(daten);

            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                // Fallback: Beispieldaten anzeigen
                loadExampleData();
            }
        }

        // Live-Werte aktualisieren
        function updateLiveValues(daten) {
            const letzterWert = daten.stundenwerte[daten.stundenwerte.length - 1];

            // Aktuelle Leistung
            document.getElementById('live-power').textContent = `${letzterWert.leistung_w} W`;
            document.getElementById('live-tarif').textContent = getTarifName(letzterWert.tarif);

            // Heutiger Verbrauch
            document.getElementById('today-consumption').textContent = `${daten.verbrauch_gesamt.toFixed(2)} kWh`;
            document.getElementById('today-cost').textContent = `CHF ${daten.verbrauch_nach_tarif.gesamt_kosten.toFixed(2)}`;

            // Solar (wenn vorhanden)
            if (daten.solar_erzeugung_gesamt) {
                document.getElementById('solar-power').textContent = `${letzterWert.solar_leistung_w || 0} W`;
                document.getElementById('solar-autarkie').textContent = `${daten.statistik.autarkie_prozent.toFixed(1)}%`;
            }
        }

        // Charts aktualisieren
        function updateCharts(daten) {
            // Verbrauchsverlauf Chart
            const ctx1 = document.getElementById('consumption-chart').getContext('2d');

            if (charts.consumption) {
                charts.consumption.destroy();
            }

            charts.consumption = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: daten.stundenwerte.map(h => new Date(h.timestamp).toLocaleTimeString('de-CH', {hour: '2-digit', minute: '2-digit'})),
                    datasets: [{
                        label: 'Verbrauch (kWh)',
                        data: daten.stundenwerte.map(h => h.verbrauch_kwh),
                        borderColor: 'rgb(234, 179, 8)',
                        backgroundColor: 'rgba(234, 179, 8, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'kWh'
                            }
                        }
                    }
                }
            });

            // Tarifaufteilung Chart
            const ctx2 = document.getElementById('tariff-chart').getContext('2d');

            if (charts.tariff) {
                charts.tariff.destroy();
            }

            const tarifDaten = daten.verbrauch_nach_tarif;
            const labels = ['Hochtarif', 'Niedertarif'];
            const values = [tarifDaten.hochtarif_kwh, tarifDaten.niedertarif_kwh];
            const colors = ['#ef4444', '#84cc16'];

            if (tarifDaten.solar_kwh) {
                labels.push('Solar');
                values.push(tarifDaten.solar_kwh);
                colors.push('#fbbf24');
            }

            charts.tariff = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Statistik-Tabelle aktualisieren
        function updateStatistics(daten) {
            const tarifDaten = daten.verbrauch_nach_tarif;
            const tbody = document.getElementById('stats-table');
            tbody.innerHTML = '';

            // Hochtarif
            tbody.innerHTML += `
                <tr>
                    <td class="px-4 py-3">
                        <span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                        Hochtarif
                    </td>
                    <td class="px-4 py-3 text-right">${tarifDaten.hochtarif_kwh.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right">${zaehlerConfig.tarife.hochtarif.preis_pro_kwh.toFixed(4)}</td>
                    <td class="px-4 py-3 text-right">${tarifDaten.hochtarif_kosten.toFixed(2)}</td>
                </tr>
            `;

            // Niedertarif
            tbody.innerHTML += `
                <tr>
                    <td class="px-4 py-3">
                        <span class="inline-block w-3 h-3 rounded-full bg-lime-500 mr-2"></span>
                        Niedertarif
                    </td>
                    <td class="px-4 py-3 text-right">${tarifDaten.niedertarif_kwh.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right">${zaehlerConfig.tarife.niedertarif.preis_pro_kwh.toFixed(4)}</td>
                    <td class="px-4 py-3 text-right">${tarifDaten.niedertarif_kosten.toFixed(2)}</td>
                </tr>
            `;

            // Solar (wenn vorhanden)
            if (tarifDaten.solar_kwh) {
                tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-3">
                            <span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>
                            Solar (Eigenverbrauch)
                        </td>
                        <td class="px-4 py-3 text-right">${tarifDaten.solar_kwh.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right">${zaehlerConfig.tarife.solar.preis_pro_kwh.toFixed(4)}</td>
                        <td class="px-4 py-3 text-right">${tarifDaten.solar_kosten.toFixed(2)}</td>
                    </tr>
                `;
            }

            // Gesamt
            document.getElementById('total-consumption').textContent = `${daten.verbrauch_gesamt.toFixed(2)} kWh`;
            document.getElementById('total-cost').textContent = `${tarifDaten.gesamt_kosten.toFixed(2)} CHF`;
        }

        // Live-Updates starten
        function startLiveUpdates() {
            // Alle 5 Sekunden Live-Daten von ioBroker abrufen
            liveUpdateInterval = setInterval(async () => {
                // Hier würde die ioBroker API abgefragt werden
                await loadDashboardData();
            }, 5000);
        }

        // Zeitraum wählen
        function selectPeriod(period) {
            currentPeriod = period;

            // Buttons aktualisieren
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('bg-yellow-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-yellow-600', 'text-white');

            // Daten neu laden
            loadDashboardData();
        }

        // Hilfsfunktionen
        function getTarifName(tarif) {
            return tarif === 'hochtarif' ? 'Hochtarif' : 'Niedertarif';
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            let colorClass = 'text-green-600';
            if (type === 'error') colorClass = 'text-red-600';
            else if (type === 'info') colorClass = 'text-blue-600';
            messageEl.className = `mt-4 text-center text-sm ${colorClass}`;
        }

        function backToEmail() {
            document.getElementById('otp-form').classList.add('hidden');
            document.getElementById('email-form').classList.remove('hidden');
            document.getElementById('otp-input').value = '';
        }

        function logout() {
            currentUser = null;
            benutzerDaten = null;

            if (liveUpdateInterval) {
                clearInterval(liveUpdateInterval);
            }

            // Charts zerstören
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('email-form').classList.remove('hidden');
            document.getElementById('otp-form').classList.add('hidden');
            document.getElementById('email-input').value = '';
            document.getElementById('otp-input').value = '';
        }

        // Beispieldaten laden (Fallback)
        function loadExampleData() {
            const beispiel = {
                verbrauch_gesamt: 8.3,
                verbrauch_nach_tarif: {
                    hochtarif_kwh: 5.2,
                    hochtarif_kosten: 1.31,
                    niedertarif_kwh: 3.1,
                    niedertarif_kosten: 0.55,
                    gesamt_kosten: 1.86
                },
                stundenwerte: [
                    {timestamp: '2024-12-18T08:00:00Z', verbrauch_kwh: 0.5, leistung_w: 450, tarif: 'hochtarif'},
                    {timestamp: '2024-12-18T12:00:00Z', verbrauch_kwh: 1.2, leistung_w: 1200, tarif: 'hochtarif'},
                    {timestamp: '2024-12-18T18:00:00Z', verbrauch_kwh: 0.8, leistung_w: 850, tarif: 'hochtarif'},
                    {timestamp: '2024-12-18T22:00:00Z', verbrauch_kwh: 0.3, leistung_w: 320, tarif: 'niedertarif'}
                ]
            };

            updateLiveValues(beispiel);
            updateCharts(beispiel);
            updateStatistics(beispiel);
        }
    </script>
</body>
</html>
