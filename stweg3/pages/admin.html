<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kontakte bearbeiten - STWEG 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        textarea {
            font-family: 'Monaco', 'Courier New', monospace;
        }
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        input.invalid {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        input.valid {
            border-color: #10b981;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center">
                        <svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="ml-2 text-xl font-semibold text-gray-800">STWEG 3 Admin</span>
                    </a>
                </div>
                <div class="flex items-center">
                    <a href="index.html" class="text-gray-700 hover:text-orange-600 transition">‚Üê Zur√ºck zu STWEG 3</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="bg-gradient-to-r from-orange-600 to-orange-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl font-bold mb-2">üîß Admin-Bereich</h1>
            <p class="text-xl opacity-90">Kontaktdaten verwalten</p>
        </div>
    </section>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Loading -->
        <div id="loading" class="bg-white rounded-lg shadow-lg p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Lade Daten...</p>
        </div>

        <!-- Schritt 1: OTP-Authentifizierung -->
        <div id="step1" class="hidden bg-white rounded-lg shadow-lg p-8">
            <div class="flex items-center mb-6">
                <div class="bg-orange-100 rounded-full p-3 mr-4">
                    <svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Admin-Zugang</h2>
                    <p class="text-sm text-gray-600">Schritt 1: Authentifizierung</p>
                </div>
            </div>

            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                <p class="text-sm text-gray-700">
                    <strong>‚ö†Ô∏è Achtung:</strong> Der Admin-Bereich ist zur Mutation durch den Ausschuss und Selbstmutation da.
                    Nur berechtigte E-Mails k√∂nnen OTP-Codes anfordern.
                </p>
            </div>

            <form id="emailForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Ihre E-Mail-Adresse (Ausschuss) *
                    </label>
                    <input
                        type="email"
                        id="userEmail"
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        placeholder="ihre@email.ch">
                </div>

                <div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded">
                    <p class="text-sm text-red-700"></p>
                </div>

                <button
                    type="submit"
                    class="w-full bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700 transition flex items-center justify-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Zugangscode per E-Mail senden
                </button>
            </form>
        </div>

        <!-- Schritt 2: OTP-Eingabe -->
        <div id="step2" class="hidden bg-white rounded-lg shadow-lg p-8">
            <div class="flex items-center mb-6">
                <div class="bg-orange-100 rounded-full p-3 mr-4">
                    <svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Code eingeben</h2>
                    <p class="text-sm text-gray-600">Schritt 2: Verifizierung</p>
                </div>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                <p class="text-sm text-gray-700">
                    Wir haben Ihnen einen 6-stelligen Code an <strong id="displayEmail"></strong> gesendet.
                    Der Code ist 10 Minuten g√ºltig.
                </p>
            </div>

            <form id="otpForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Zugangscode *
                    </label>
                    <input
                        type="text"
                        id="otpInput"
                        required
                        maxlength="6"
                        pattern="[0-9]{6}"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-center text-2xl tracking-widest font-mono"
                        placeholder="123456">
                </div>

                <div id="otpErrorMessage" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded">
                    <p class="text-sm text-red-700"></p>
                </div>

                <button
                    type="submit"
                    class="w-full bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700 transition">
                    Code best√§tigen
                </button>

                <button
                    type="button"
                    onclick="backToStep1()"
                    class="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-200 transition">
                    Zur√ºck
                </button>
            </form>
        </div>

        <!-- Schritt 3: Editor -->
        <div id="step3" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="bg-green-100 rounded-full p-3 mr-4">
                            <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Zugriff gew√§hrt</h2>
                            <p class="text-sm text-gray-600">
                                Angemeldet als: <strong id="loggedInEmail"></strong>
                                <span id="permissionBadge" class="ml-2"></span>
                            </p>
                        </div>
                    </div>
                    <button
                        onclick="logout()"
                        class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition text-sm">
                        Abmelden
                    </button>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                    <p class="text-sm text-gray-700">
                        <strong>‚ö†Ô∏è Wichtig:</strong> √Ñnderungen werden sofort gespeichert und sind f√ºr alle Nutzer sichtbar.
                        Stellen Sie sicher, dass das JSON-Format korrekt ist!
                    </p>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Benutzerfreundlicher Editor</h3>
                    <p class="text-sm text-gray-600 mb-4">W√§hlen Sie eine Wohnung aus, um deren Daten zu bearbeiten:</p>

                    <!-- Wohnungsauswahl -->
                    <div class="grid md:grid-cols-3 gap-4 mb-6" id="wohnungList">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>

                    <!-- Bearbeitungsformular -->
                    <div id="editForm" class="hidden">
                        <div class="bg-gray-50 rounded-lg p-6 mb-4">
                            <h4 class="font-semibold text-gray-800 mb-4" id="editFormTitle"></h4>
                            <div id="formFields" class="space-y-4">
                                <!-- Wird dynamisch gef√ºllt -->
                            </div>
                            <div class="flex gap-2 mt-6">
                                <button
                                    onclick="saveChanges()"
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                                    √Ñnderungen speichern
                                </button>
                                <button
                                    onclick="cancelEdit()"
                                    class="bg-gray-100 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-200 transition">
                                    Abbrechen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Save Button (always visible) -->
                <div class="mb-6 flex gap-4">
                    <button
                        onclick="saveJSON()"
                        class="flex-1 bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700 transition flex items-center justify-center shadow-lg">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        üíæ Alle √Ñnderungen speichern
                    </button>
                    <label class="flex items-center gap-2 bg-blue-50 px-4 py-3 rounded-lg border border-blue-200 cursor-pointer hover:bg-blue-100 transition">
                        <input type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()" class="w-4 h-4">
                        <span class="text-sm font-medium text-blue-900">üîÑ Auto-Speichern</span>
                    </label>
                </div>

                <div id="autoSaveStatus" class="hidden bg-green-50 border-l-4 border-green-500 p-3 mb-6 rounded">
                    <p class="text-sm text-green-700">
                        ‚úÖ Auto-Speichern aktiviert - √Ñnderungen werden automatisch alle 30 Sekunden gespeichert
                    </p>
                </div>

                <details class="mb-6" open>
                    <summary class="cursor-pointer text-lg font-semibold text-gray-800 mb-2 hover:text-orange-600">
                        üîß Erweitert: JSON direkt bearbeiten
                    </summary>
                    <div class="mt-4">
                        <!-- Warning for non-Ausschuss members -->
                        <div id="jsonEditWarning" class="hidden bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded mb-4">
                            <p class="text-sm text-yellow-700">
                                ‚ö†Ô∏è <strong>Hinweis:</strong> Sie k√∂nnen nur Ihre eigenen Wohnungsdaten bearbeiten.
                                F√ºr erweiterte Bearbeitungsrechte wenden Sie sich an ein Ausschussmitglied.
                            </p>
                        </div>

                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">
                                kontakte.json
                            </label>
                            <div class="flex gap-2">
                                <button
                                    onclick="formatJSON()"
                                    class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 transition">
                                    Formatieren
                                </button>
                                <button
                                    onclick="validateJSON()"
                                    class="bg-purple-100 text-purple-700 px-3 py-1 rounded text-sm hover:bg-purple-200 transition">
                                    Validieren
                                </button>
                            </div>
                        </div>
                        <textarea
                            id="jsonEditor"
                            class="w-full h-96 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm font-mono"
                            spellcheck="false"
                            oninput="onJSONChange()"></textarea>

                        <div id="jsonError" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded mt-4">
                            <p class="text-sm text-red-700"></p>
                        </div>

                        <div id="jsonSuccess" class="hidden bg-green-50 border-l-4 border-green-500 p-4 rounded mt-4">
                            <p class="text-sm text-green-700">JSON ist g√ºltig! ‚úì</p>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm text-gray-400">
                ¬© 2025 STWEG 3 - Teil der STWEG-Kooperation Rosenweg
            </p>
        </div>
    </footer>

    <script>
        // ============================================
        // KONFIGURATION
        // ============================================

        // n8n Webhook URL f√ºr OTP-Versand
        const N8N_WEBHOOK_URL = 'https://n8n.juroct.net/webhook/stweg3-otp';

        // n8n Webhook URL zum Speichern (muss noch erstellt werden)
        const N8N_SAVE_WEBHOOK_URL = 'https://n8n.juroct.net/webhook/stweg3-save-json';

        // Pfad zur JSON-Datei
        const KONTAKTE_JSON_URL = '../data/kontakte.json';

        // n8n Webhook URL (wird dynamisch aus kontakte.json geladen)
        let N8N_EMAIL_CHANGE_WEBHOOK_URL = null;

        // ============================================
        // GLOBALE VARIABLEN
        // ============================================

        let kontakteData = null;
        let originalKontakteData = null; // F√ºr Change-Tracking
        let ausschussEmails = [];
        let currentEmail = '';
        let currentOTP = '';
        let otpTimestamp = 0;
        let currentEditingWohnung = null;

        // ============================================
        // VALIDIERUNGS-FUNKTIONEN
        // ============================================

        function validateEmail(email) {
            if (!email || email.trim() === '') {
                return { valid: false, error: 'E-Mail-Adresse darf nicht leer sein' };
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { valid: false, error: 'Ung√ºltiges E-Mail-Format' };
            }
            return { valid: true };
        }

        function validateTelefon(telefon) {
            if (!telefon || telefon.trim() === '') {
                return { valid: true }; // Telefon ist optional
            }
            // Erlaube: +41 79 123 45 67, 079 123 45 67, +41791234567, etc.
            const telRegex = /^[\d\s\+\-\(\)]+$/;
            if (!telRegex.test(telefon)) {
                return { valid: false, error: 'Telefonnummer darf nur Zahlen, +, -, (, ) und Leerzeichen enthalten' };
            }
            return { valid: true };
        }

        function validateName(name) {
            if (!name || name.trim() === '') {
                return { valid: false, error: 'Name darf nicht leer sein' };
            }
            if (name.trim().length < 2) {
                return { valid: false, error: 'Name muss mindestens 2 Zeichen lang sein' };
            }
            return { valid: true };
        }

        function showValidationError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-20 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            successDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }

        // ============================================
        // HILFSFUNKTION: BERECHTIGTE E-MAILS EXTRAHIEREN
        // ============================================

        function extractBerechtigteEmails(data) {
            const emails = new Set();

            // 1. Ausschuss-Mitglieder (k√∂nnen alles bearbeiten)
            if (data.ausschuss) {
                data.ausschuss.forEach(vertreter => {
                    if (vertreter.email) {
                        const emailArray = vertreter.email.split(',');
                        emailArray.forEach(email => {
                            const trimmed = email.trim().toLowerCase();
                            if (trimmed && trimmed.includes('@')) {
                                emails.add(trimmed);
                            }
                        });
                    }
                });
            }

            // 2. Alle Eigent√ºmer (k√∂nnen ihre eigenen Daten bearbeiten)
            if (data.wohnungen) {
                ['erdgeschoss', 'obergeschoss_1', 'obergeschoss_2'].forEach(etage => {
                    if (data.wohnungen[etage]) {
                        data.wohnungen[etage].forEach(wohnung => {
                            if (wohnung.eigent√ºmer && wohnung.eigent√ºmer.email) {
                                const trimmed = wohnung.eigent√ºmer.email.trim().toLowerCase();
                                if (trimmed && trimmed.includes('@')) {
                                    emails.add(trimmed);
                                }
                            }
                            // 3. Berechtigte Mieter (k√∂nnen ihre eigenen Daten bearbeiten)
                            if (wohnung.mieter && wohnung.mieter.berechtigt && wohnung.mieter.email) {
                                const trimmed = wohnung.mieter.email.trim().toLowerCase();
                                if (trimmed && trimmed.includes('@')) {
                                    emails.add(trimmed);
                                }
                            }
                        });
                    }
                });
            }

            console.log('Berechtigte E-Mails f√ºr Admin-Zugang:', Array.from(emails));
            return Array.from(emails);
        }

        // ============================================
        // INITIALISIERUNG
        // ============================================

        window.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch(KONTAKTE_JSON_URL);
                if (!response.ok) {
                    throw new Error('Kontakte konnten nicht geladen werden');
                }

                kontakteData = await response.json();
                originalKontakteData = JSON.parse(JSON.stringify(kontakteData)); // Deep copy f√ºr Change-Tracking
                ausschussEmails = extractBerechtigteEmails(kontakteData);

                // Lade Webhook-URL aus JSON
                if (kontakteData.stweg?.webhooks?.email_change_notification) {
                    N8N_EMAIL_CHANGE_WEBHOOK_URL = kontakteData.stweg.webhooks.email_change_notification;
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');

            } catch (error) {
                console.error('Fehler beim Laden der Kontakte:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-red-600">
                        <svg class="h-12 w-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="font-semibold mb-2">Fehler beim Laden der Daten</p>
                        <p class="text-sm">Bitte versuchen Sie es sp√§ter erneut.</p>
                    </div>
                `;
            }
        });

        // ============================================
        // SCHRITT 1: E-MAIL EINGABE
        // ============================================

        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('userEmail').value.trim().toLowerCase();
            const errorDiv = document.getElementById('errorMessage');
            const submitButton = e.target.querySelector('button[type="submit"]');

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="animate-spin inline-block mr-2">‚è≥</span> Wird gesendet...';

            // Pr√ºfe, ob E-Mail berechtigt ist (Ausschuss, Eigent√ºmer oder berechtigter Mieter)
            if (!ausschussEmails.includes(email)) {
                errorDiv.classList.remove('hidden');
                errorDiv.querySelector('p').textContent =
                    'Diese E-Mail-Adresse ist nicht berechtigt. Zugang haben: Ausschussmitglieder, Eigent√ºmer und berechtigte Mieter.';
                submitButton.disabled = false;
                submitButton.innerHTML = `
                    <svg class="h-5 w-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Zugangscode per E-Mail senden
                `;
                return;
            }

            // OTP generieren
            currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
            otpTimestamp = Date.now();
            currentEmail = email;

            try {
                // OTP per n8n versenden
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        otp_code: currentOTP,
                        source: 'STWEG 3 - Admin-Bereich'
                    })
                });

                if (!response.ok) {
                    throw new Error('E-Mail konnte nicht gesendet werden');
                }

                // Zu Schritt 2 wechseln
                errorDiv.classList.add('hidden');
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('displayEmail').textContent = email;

            } catch (error) {
                console.error('Fehler beim Senden:', error);
                errorDiv.classList.remove('hidden');
                errorDiv.querySelector('p').textContent =
                    'Fehler beim Versenden des Codes. Bitte versuchen Sie es erneut.';
            }

            submitButton.disabled = false;
            submitButton.innerHTML = `
                <svg class="h-5 w-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                Zugangscode per E-Mail senden
            `;
        });

        // ============================================
        // SCHRITT 2: OTP VALIDIERUNG
        // ============================================

        document.getElementById('otpForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const enteredOTP = document.getElementById('otpInput').value;
            const errorDiv = document.getElementById('otpErrorMessage');

            // Pr√ºfe OTP-G√ºltigkeit (10 Minuten)
            const now = Date.now();
            const tenMinutes = 10 * 60 * 1000;

            if (now - otpTimestamp > tenMinutes) {
                errorDiv.classList.remove('hidden');
                errorDiv.querySelector('p').textContent =
                    'Der Code ist abgelaufen. Bitte fordern Sie einen neuen Code an.';
                return;
            }

            // Pr√ºfe OTP
            if (enteredOTP !== currentOTP) {
                errorDiv.classList.remove('hidden');
                errorDiv.querySelector('p').textContent =
                    'Ung√ºltiger Code. Bitte √ºberpr√ºfen Sie Ihre Eingabe.';
                return;
            }

            // Erfolgreich authentifiziert
            errorDiv.classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('loggedInEmail').textContent = currentEmail;

            // JSON-Editor bef√ºllen
            loadEditor();
        });

        function backToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('otpInput').value = '';
            document.getElementById('otpErrorMessage').classList.add('hidden');
        }

        // ============================================
        // EDITOR-FUNKTIONEN
        // ============================================

        function loadEditor() {
            // JSON in Editor laden
            document.getElementById('jsonEditor').value = JSON.stringify(kontakteData, null, 2);

            // Check permissions and show warning if not Ausschuss
            checkEditPermissions();

            // Wohnungsliste generieren
            loadWohnungList();
        }

        function checkEditPermissions() {
            const isAusschuss = kontakteData.ausschuss && kontakteData.ausschuss.some(a => a.email === currentEmail);
            const warningDiv = document.getElementById('jsonEditWarning');
            const permissionBadge = document.getElementById('permissionBadge');

            if (!isAusschuss) {
                warningDiv.classList.remove('hidden');
                permissionBadge.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">üë§ Bewohner</span>';
            } else {
                warningDiv.classList.add('hidden');
                permissionBadge.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">‚≠ê Ausschuss</span>';
            }
        }

        function loadWohnungList() {
            const wohnungList = document.getElementById('wohnungList');
            wohnungList.innerHTML = '';

            // Erdgeschoss
            if (kontakteData.wohnungen.erdgeschoss) {
                kontakteData.wohnungen.erdgeschoss.forEach((wohnung, idx) => {
                    wohnungList.innerHTML += createWohnungCard(wohnung, 'erdgeschoss', idx);
                });
            }

            // 1. OG
            if (kontakteData.wohnungen.obergeschoss_1) {
                kontakteData.wohnungen.obergeschoss_1.forEach((wohnung, idx) => {
                    wohnungList.innerHTML += createWohnungCard(wohnung, 'obergeschoss_1', idx);
                });
            }

            // 2. OG
            if (kontakteData.wohnungen.obergeschoss_2) {
                kontakteData.wohnungen.obergeschoss_2.forEach((wohnung, idx) => {
                    wohnungList.innerHTML += createWohnungCard(wohnung, 'obergeschoss_2', idx);
                });
            }
        }

        function createWohnungCard(wohnung, etage, idx) {
            const canEdit = canEditWohnung(wohnung);
            const editableClass = canEdit ? 'hover:border-orange-400 cursor-pointer' : 'opacity-60 cursor-not-allowed';
            const lockIcon = canEdit ? '' : '<span class="text-gray-400 text-xs">üîí</span>';

            return `
                <div class="bg-white border-2 border-gray-200 rounded-lg p-4 ${editableClass} transition"
                     ${canEdit ? `onclick="editWohnung('${etage}', ${idx})"` : ''}>
                    <div class="font-semibold text-gray-800 mb-1 flex items-center justify-between">
                        <span>${wohnung.bezeichnung}</span>
                        ${lockIcon}
                    </div>
                    <div class="text-sm text-gray-600">${wohnung.eigent√ºmer.name}</div>
                    <div class="text-xs text-gray-500 mt-2">${wohnung.zimmer} Zi. ‚Ä¢ ${wohnung.flaeche_m2}m¬≤</div>
                </div>
            `;
        }

        function editWohnung(etage, idx) {
            currentEditingWohnung = { etage, idx };
            const wohnung = kontakteData.wohnungen[etage][idx];

            // Permission check
            if (!canEditWohnung(wohnung)) {
                alert('Sie haben keine Berechtigung, diese Wohnung zu bearbeiten.\n\nSie k√∂nnen nur Ihre eigenen Daten √§ndern. Ausschussmitglieder k√∂nnen alle Daten √§ndern.');
                return;
            }

            document.getElementById('editFormTitle').textContent = `Wohnung ${wohnung.bezeichnung} bearbeiten`;

            const formFields = document.getElementById('formFields');
            formFields.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Eigent√ºmer Name *</label>
                    <input type="text" id="edit_eigentuemer_name" value="${wohnung.eigent√ºmer.name}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                           oninput="validateFieldRealtime(this, 'name')">
                    <p class="text-xs text-gray-500 mt-1">Mindestens 2 Zeichen</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Eigent√ºmer E-Mail *</label>
                    <input type="email" id="edit_eigentuemer_email" value="${wohnung.eigent√ºmer.email}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                           oninput="validateFieldRealtime(this, 'email')">
                    <p class="text-xs text-gray-500 mt-1">G√ºltiges E-Mail-Format erforderlich</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Eigent√ºmer Telefon</label>
                    <input type="tel" id="edit_eigentuemer_telefon" value="${wohnung.eigent√ºmer.telefon}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                           oninput="validateFieldRealtime(this, 'telefon')">
                    <p class="text-xs text-gray-500 mt-1">Nur Zahlen, +, -, ( ) und Leerzeichen</p>
                </div>

                <div class="pt-4 border-t border-gray-200">
                    <label class="flex items-center mb-3">
                        <input type="checkbox" id="edit_has_mieter" ${wohnung.mieter ? 'checked' : ''}
                               class="mr-2 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded"
                               onchange="toggleMieterFields()">
                        <span class="text-sm font-semibold text-gray-800">Wohnung hat Mieter</span>
                    </label>

                    <div id="mieter_fields" class="${wohnung.mieter ? '' : 'hidden'} space-y-3">
                        <h5 class="font-semibold text-gray-800 mb-2">Mieter-Daten</h5>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mieter Name *</label>
                                <input type="text" id="edit_mieter_name" value="${wohnung.mieter ? wohnung.mieter.name : ''}" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                       oninput="validateFieldRealtime(this, 'name')">
                                <p class="text-xs text-gray-500 mt-1">Mindestens 2 Zeichen</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mieter E-Mail *</label>
                                <input type="email" id="edit_mieter_email" value="${wohnung.mieter ? wohnung.mieter.email : ''}" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                       oninput="validateFieldRealtime(this, 'email')">
                                <p class="text-xs text-gray-500 mt-1">G√ºltiges E-Mail-Format erforderlich</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mieter Telefon</label>
                                <input type="tel" id="edit_mieter_telefon" value="${wohnung.mieter ? wohnung.mieter.telefon : ''}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                       oninput="validateFieldRealtime(this, 'telefon')">
                                <p class="text-xs text-gray-500 mt-1">Nur Zahlen, +, -, ( ) und Leerzeichen</p>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="edit_mieter_berechtigt" ${wohnung.mieter && wohnung.mieter.berechtigt ? 'checked' : ''}
                                           class="mr-2 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                    <span class="text-sm text-gray-700">Mieter hat Zugriff auf Kontaktliste</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
            `;

            document.getElementById('editForm').classList.remove('hidden');
        }

        async function saveChanges() {
            if (!currentEditingWohnung) return;

            const { etage, idx } = currentEditingWohnung;
            const wohnung = kontakteData.wohnungen[etage][idx];
            const originalWohnung = originalKontakteData.wohnungen[etage][idx];

            // Neue Werte aus dem Formular
            const newEigentuemerName = document.getElementById('edit_eigentuemer_name').value.trim();
            const newEigentuemerEmail = document.getElementById('edit_eigentuemer_email').value.trim().toLowerCase();
            const newEigentuemerTelefon = document.getElementById('edit_eigentuemer_telefon').value.trim();

            // VALIDIERUNG: Eigent√ºmer
            const nameValidation = validateName(newEigentuemerName);
            if (!nameValidation.valid) {
                showValidationError('Eigent√ºmer: ' + nameValidation.error);
                return;
            }

            const emailValidation = validateEmail(newEigentuemerEmail);
            if (!emailValidation.valid) {
                showValidationError('Eigent√ºmer E-Mail: ' + emailValidation.error);
                return;
            }

            const telefonValidation = validateTelefon(newEigentuemerTelefon);
            if (!telefonValidation.valid) {
                showValidationError('Eigent√ºmer Telefon: ' + telefonValidation.error);
                return;
            }

            // Track E-Mail √Ñnderungen f√ºr Benachrichtigung
            const emailChanges = [];

            // Check ob Eigent√ºmer-E-Mail ge√§ndert wurde
            if (originalWohnung.eigent√ºmer.email !== newEigentuemerEmail) {
                emailChanges.push({
                    type: 'Eigent√ºmer',
                    oldEmail: originalWohnung.eigent√ºmer.email,
                    newEmail: newEigentuemerEmail,
                    name: newEigentuemerName,
                    wohnung: wohnung.bezeichnung,
                    changes: {
                        name: { old: originalWohnung.eigent√ºmer.name, new: newEigentuemerName },
                        email: { old: originalWohnung.eigent√ºmer.email, new: newEigentuemerEmail },
                        telefon: { old: originalWohnung.eigent√ºmer.telefon, new: newEigentuemerTelefon }
                    }
                });
            }

            // Check ob Mieter-Checkbox aktiviert ist
            const hasMieter = document.getElementById('edit_has_mieter').checked;

            // Mieter-Validierung und Verarbeitung
            if (hasMieter) {
                const newMieterName = document.getElementById('edit_mieter_name').value.trim();
                const newMieterEmail = document.getElementById('edit_mieter_email').value.trim().toLowerCase();
                const newMieterTelefon = document.getElementById('edit_mieter_telefon').value.trim();
                const newMieterBerechtigt = document.getElementById('edit_mieter_berechtigt').checked;

                const mieterNameValidation = validateName(newMieterName);
                if (!mieterNameValidation.valid) {
                    showValidationError('Mieter: ' + mieterNameValidation.error);
                    return;
                }

                const mieterEmailValidation = validateEmail(newMieterEmail);
                if (!mieterEmailValidation.valid) {
                    showValidationError('Mieter E-Mail: ' + mieterEmailValidation.error);
                    return;
                }

                const mieterTelefonValidation = validateTelefon(newMieterTelefon);
                if (!mieterTelefonValidation.valid) {
                    showValidationError('Mieter Telefon: ' + mieterTelefonValidation.error);
                    return;
                }

                // Check ob Mieter-E-Mail ge√§ndert wurde
                if (originalWohnung.mieter && originalWohnung.mieter.email !== newMieterEmail) {
                    emailChanges.push({
                        type: 'Mieter',
                        oldEmail: originalWohnung.mieter.email,
                        newEmail: newMieterEmail,
                        name: newMieterName,
                        wohnung: wohnung.bezeichnung,
                        changes: {
                            name: { old: originalWohnung.mieter.name, new: newMieterName },
                            email: { old: originalWohnung.mieter.email, new: newMieterEmail },
                            telefon: { old: originalWohnung.mieter.telefon, new: newMieterTelefon }
                        }
                    });
                }

                // Mieter aktualisieren oder erstellen
                if (!wohnung.mieter) {
                    // Neuer Mieter wird hinzugef√ºgt
                    wohnung.mieter = {
                        name: newMieterName,
                        email: newMieterEmail,
                        telefon: newMieterTelefon,
                        berechtigt: newMieterBerechtigt
                    };
                } else {
                    // Bestehender Mieter wird aktualisiert
                    wohnung.mieter.name = newMieterName;
                    wohnung.mieter.email = newMieterEmail;
                    wohnung.mieter.telefon = newMieterTelefon;
                    wohnung.mieter.berechtigt = newMieterBerechtigt;
                }
            } else {
                // Checkbox ist nicht aktiviert - Mieter entfernen
                wohnung.mieter = null;
            }

            // Eigent√ºmer aktualisieren
            wohnung.eigent√ºmer.name = newEigentuemerName;
            wohnung.eigent√ºmer.email = newEigentuemerEmail;
            wohnung.eigent√ºmer.telefon = newEigentuemerTelefon;

            // Metadaten aktualisieren
            kontakteData.metadaten.letzte_√§nderung = new Date().toISOString().split('T')[0];

            // Verteilerlisten automatisch aktualisieren und √Ñnderungen verfolgen
            const oldVerteilerlisten = kontakteData.verteilerlisten;
            const newVerteilerlisten = generateVerteilerListen(kontakteData);
            kontakteData.verteilerlisten = newVerteilerlisten;
            console.log('Verteilerlisten nach √Ñnderung aktualisiert');

            // Pr√ºfe auf Verteilerlisten-√Ñnderungen
            const verteilerChanges = compareVerteilerListen(oldVerteilerlisten, newVerteilerlisten);
            if (verteilerChanges && verteilerChanges.hasChanges) {
                console.log('Verteilerlisten-√Ñnderungen erkannt:', verteilerChanges);
                await sendVerteilerListenNotification(verteilerChanges);
            }

            // E-Mail-Benachrichtigungen senden
            if (emailChanges.length > 0) {
                await sendEmailChangeNotifications(emailChanges);
            }

            // JSON-Editor aktualisieren
            document.getElementById('jsonEditor').value = JSON.stringify(kontakteData, null, 2);

            // WICHTIG: originalKontakteData aktualisieren, damit weitere √Ñnderungen erkannt werden
            originalKontakteData = JSON.parse(JSON.stringify(kontakteData));

            // Formular schlie√üen
            cancelEdit();

            // Wohnungsliste neu laden
            loadWohnungList();

            // Erfolgs-Nachricht
            showSuccessMessage('√Ñnderungen wurden √ºbernommen. Klicken Sie auf "Alle √Ñnderungen speichern", um dauerhaft zu speichern.');
        }

        function cancelEdit() {
            document.getElementById('editForm').classList.add('hidden');
            currentEditingWohnung = null;
        }

        function toggleMieterFields() {
            const checkbox = document.getElementById('edit_has_mieter');
            const mieterFields = document.getElementById('mieter_fields');

            if (checkbox.checked) {
                mieterFields.classList.remove('hidden');
            } else {
                mieterFields.classList.add('hidden');
            }
        }

        // ============================================
        // REAL-TIME VALIDIERUNG
        // ============================================

        function validateFieldRealtime(inputElement, type) {
            const value = inputElement.value.trim();
            let validation;

            switch (type) {
                case 'name':
                    validation = validateName(value);
                    break;
                case 'email':
                    validation = validateEmail(value);
                    break;
                case 'telefon':
                    validation = validateTelefon(value);
                    break;
                default:
                    return;
            }

            // Visual Feedback
            inputElement.classList.remove('invalid', 'valid');
            if (value === '' && type !== 'telefon') {
                // Leeres Pflichtfeld
                inputElement.classList.add('invalid');
            } else if (value !== '') {
                if (validation.valid) {
                    inputElement.classList.add('valid');
                } else {
                    inputElement.classList.add('invalid');
                }
            }
        }

        // ============================================
        // E-MAIL-BENACHRICHTIGUNGEN
        // ============================================

        // Generische E-Mail-Funktion
        async function sendEmail(recipients, subject, htmlContent, options = {}) {
            try {
                const webhookUrl = kontakteData.stweg?.webhooks?.send_email;

                if (!webhookUrl) {
                    console.warn('‚ö†Ô∏è Keine Webhook-URL f√ºr E-Mail-Versand konfiguriert');
                    return false;
                }

                const payload = {
                    recipients: Array.isArray(recipients) ? recipients : [recipients],
                    subject: subject,
                    htmlContent: htmlContent,
                    cc: options.cc || [],
                    bcc: options.bcc || [],
                    replyTo: options.replyTo || kontakteData.stweg?.kontakt_email || ''
                };

                console.log('Sende E-Mail:', { recipients: payload.recipients, subject });

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    console.log('‚úÖ E-Mail erfolgreich gesendet');
                    return true;
                } else {
                    console.error('‚ùå Fehler beim Senden:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Fehler beim E-Mail-Versand:', error);
                return false;
            }
        }

        // HTML-Template f√ºr E-Mail-Adress√§nderung
        function generateEmailChangeHTML(data) {
            return `<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0; }
        .content { background: #f9fafb; padding: 30px; border: 1px solid #e5e7eb; }
        .changes { background: white; padding: 15px; margin: 20px 0; border-left: 4px solid #10b981; border-radius: 4px; }
        .footer { background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; font-size: 12px; border-radius: 0 0 8px 8px; }
        .info { background: #dbeafe; border: 1px solid #3b82f6; padding: 15px; border-radius: 4px; margin: 20px 0; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        li:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="margin: 0;">‚úÖ STWEG ${data.stwegNummer} Rosenweg</h1>
            <p style="margin: 5px 0 0 0; opacity: 0.9;">Best√§tigung</p>
        </div>
        <div class="content">
            <h2>Ihre Kontaktdaten wurden erfolgreich aktualisiert</h2>
            <p>Hallo,</p>
            <p>Ihre Kontaktdaten f√ºr <strong>${data.wohnung}</strong> (${data.type}) wurden erfolgreich im STWEG ${data.stwegNummer} Admin-Bereich aktualisiert.</p>
            <div class="changes">
                <h3 style="margin-top: 0;">üìù Folgende √Ñnderungen wurden vorgenommen:</h3>
                <ul style="list-style: disc; padding-left: 20px; margin: 10px 0;">
                    ${data.changeList.map(c => `<li>${c}</li>`).join('')}
                </ul>
            </div>
            <div class="info">
                <strong>‚úÖ Best√§tigung:</strong> Diese E-Mail-Adresse (<strong>${data.newEmail}</strong>) ist nun als Ihre aktuelle Kontaktadresse registriert.
                Alle zuk√ºnftigen Benachrichtigungen werden an diese Adresse gesendet.
            </div>
            <p><strong>Details zur √Ñnderung:</strong></p>
            <ul style="background: white; padding: 15px; border-radius: 4px;">
                <li><strong>Zeitpunkt:</strong> ${new Date(data.timestamp).toLocaleString('de-CH')}</li>
                <li><strong>Ge√§ndert von:</strong> ${data.changedBy}</li>
                <li><strong>Wohnung:</strong> ${data.wohnung}</li>
                <li><strong>Art:</strong> ${data.type}</li>
                <li><strong>Vorherige E-Mail:</strong> ${data.oldEmail}</li>
            </ul>
            <p>Falls Sie Fragen haben oder diese √Ñnderung nicht vorgenommen haben, wenden Sie sich bitte an den Ausschuss (<strong>${data.ausschussEmail}</strong>) oder an <strong>${data.changedBy}</strong>.</p>
        </div>
        <div class="footer">
            <p>¬© 2025 STWEG ${data.stwegNummer} - Teil der STWEG-Kooperation Rosenweg<br>
            ${data.stwegAdresse}, ${data.stwegOrt}</p>
            <p style="margin-top: 15px; font-size: 11px; color: #6b7280;">
                Diese E-Mail wurde automatisch generiert. Bitte antworten Sie nicht direkt auf diese E-Mail.
            </p>
        </div>
    </div>
</body>
</html>`;
        }

        // HTML-Template f√ºr Verteilerlisten-√Ñnderung
        function generateVerteilerChangeHTML(data) {
            const changeListHTML = data.changes.map(detail => {
                const typeName = {
                    'eigentuemer': 'Eigent√ºmer',
                    'ausschuss': 'Ausschuss',
                    'bewohner': 'Bewohner',
                    'alle': 'Alle'
                }[detail.type];

                let html = `<li><strong>${typeName}</strong>: ${detail.oldCount} ‚Üí ${detail.newCount} Mitglieder`;
                if (detail.added.length > 0) {
                    html += `<br><span style="color: #059669;">‚ûï Hinzugef√ºgt: ${detail.added.join(', ')}</span>`;
                }
                if (detail.removed.length > 0) {
                    html += `<br><span style="color: #dc2626;">‚ûñ Entfernt: ${detail.removed.join(', ')}</span>`;
                }
                html += '</li>';
                return html;
            }).join('');

            return `<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0; }
        .content { background: #f9fafb; padding: 30px; border: 1px solid #e5e7eb; }
        .changes { background: white; padding: 15px; margin: 20px 0; border-left: 4px solid #3b82f6; border-radius: 4px; }
        .footer { background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; font-size: 12px; border-radius: 0 0 8px 8px; }
        .info { background: #dbeafe; border: 1px solid #3b82f6; padding: 15px; border-radius: 4px; margin: 20px 0; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        li:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="margin: 0;">üìã STWEG ${data.stwegNummer} Rosenweg</h1>
            <p style="margin: 5px 0 0 0; opacity: 0.9;">Verteilerlisten ge√§ndert</p>
        </div>
        <div class="content">
            <h2>√Ñnderungen an den E-Mail-Verteilerlisten</h2>
            <p>Hallo Ausschussmitglied,</p>
            <p>Die E-Mail-Verteilerlisten wurden im STWEG ${data.stwegNummer} Admin-Bereich aktualisiert.</p>
            <div class="changes">
                <h3 style="margin-top: 0;">üìù Folgende Verteilerlisten haben sich ge√§ndert:</h3>
                <ul>${changeListHTML}</ul>
            </div>
            <div class="info">
                <strong>‚ÑπÔ∏è Information:</strong> Diese √Ñnderungen wurden automatisch erkannt und die Verteilerlisten sind bereits aktualisiert.
            </div>
            <p><strong>Details zur √Ñnderung:</strong></p>
            <ul style="background: white; padding: 15px; border-radius: 4px;">
                <li><strong>Zeitpunkt:</strong> ${new Date(data.timestamp).toLocaleString('de-CH')}</li>
                <li><strong>Ge√§ndert durch:</strong> ${data.changedBy}</li>
                <li><strong>Anzahl betroffener Listen:</strong> ${data.changes.length}</li>
            </ul>
            <h3>üìä Aktuelle Verteilerlisten-√úbersicht:</h3>
            <ul style="background: white; padding: 15px; border-radius: 4px;">
                <li><strong>Eigent√ºmer:</strong> Alle Wohnungseigent√ºmer</li>
                <li><strong>Ausschuss:</strong> Ausschussmitglieder mit Funktion</li>
                <li><strong>Bewohner:</strong> Mieter (falls vorhanden) oder Eigent√ºmer</li>
                <li><strong>Alle:</strong> Alle Eigent√ºmer + berechtigte Mieter</li>
            </ul>
            <p>Bei Fragen wenden Sie sich bitte an <strong>${data.changedBy}</strong>.</p>
        </div>
        <div class="footer">
            <p>¬© 2025 STWEG ${data.stwegNummer} - Teil der STWEG-Kooperation Rosenweg<br>
            ${data.stwegAdresse}, ${data.stwegOrt}</p>
            <p style="margin-top: 15px; font-size: 11px; color: #6b7280;">
                Diese E-Mail wurde automatisch generiert.
            </p>
        </div>
    </div>
</body>
</html>`;
        }

        async function sendEmailChangeNotifications(emailChanges) {
            for (const change of emailChanges) {
                try {
                    console.log('Sende Benachrichtigung an alte E-Mail:', change.oldEmail);

                    // Hole offizielle STWEG Kontakt-E-Mail
                    const ausschussEmail = kontakteData.stweg?.kontakt_email || 'stweg3@rosenweg4303.ch';

                    // Erstelle lesbare √Ñnderungsliste
                    const changeList = [];
                    if (change.changes.name.old !== change.changes.name.new) {
                        changeList.push(`Name: "${change.changes.name.old}" ‚Üí "${change.changes.name.new}"`);
                    }
                    if (change.changes.email.old !== change.changes.email.new) {
                        changeList.push(`E-Mail: "${change.changes.email.old}" ‚Üí "${change.changes.email.new}"`);
                    }
                    if (change.changes.telefon.old !== change.changes.telefon.new) {
                        changeList.push(`Telefon: "${change.changes.telefon.old}" ‚Üí "${change.changes.telefon.new}"`);
                    }

                    // Generiere HTML
                    const htmlContent = generateEmailChangeHTML({
                        oldEmail: change.oldEmail,
                        newEmail: change.newEmail,
                        type: change.type,
                        name: change.name,
                        wohnung: change.wohnung,
                        changeList: changeList,
                        changedBy: currentEmail,
                        timestamp: new Date().toISOString(),
                        ausschussEmail: ausschussEmail,
                        stwegNummer: kontakteData.stweg?.nummer || 3,
                        stwegAdresse: kontakteData.stweg?.adresse || 'Rosenweg 9',
                        stwegOrt: `${kontakteData.stweg?.plz || '4303'} ${kontakteData.stweg?.ort || 'Kaiseraugst'}`
                    });

                    // Sende E-Mail
                    const success = await sendEmail(
                        change.oldEmail,
                        `STWEG ${kontakteData.stweg?.nummer || 3}: Ihre Kontaktdaten wurden aktualisiert`,
                        htmlContent
                    );

                    if (success) {
                        console.log('‚úì Benachrichtigung erfolgreich gesendet an:', change.oldEmail);
                        showSuccessMessage(`Benachrichtigung wurde an ${change.oldEmail} gesendet`);
                    }
                } catch (error) {
                    console.error('Fehler beim Senden der Benachrichtigung:', error);
                }
            }
        }

        function formatJSON() {
            try {
                const jsonText = document.getElementById('jsonEditor').value;
                const parsed = JSON.parse(jsonText);
                document.getElementById('jsonEditor').value = JSON.stringify(parsed, null, 2);
                document.getElementById('jsonError').classList.add('hidden');
                document.getElementById('jsonSuccess').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('jsonSuccess').classList.add('hidden');
                }, 3000);
            } catch (error) {
                document.getElementById('jsonError').classList.remove('hidden');
                document.getElementById('jsonError').querySelector('p').textContent =
                    'Fehler beim Formatieren: ' + error.message;
            }
        }

        function validateJSON() {
            try {
                const jsonText = document.getElementById('jsonEditor').value;
                JSON.parse(jsonText);
                document.getElementById('jsonError').classList.add('hidden');
                document.getElementById('jsonSuccess').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('jsonSuccess').classList.add('hidden');
                }, 3000);
            } catch (error) {
                document.getElementById('jsonError').classList.remove('hidden');
                document.getElementById('jsonError').querySelector('p').textContent =
                    'JSON-Fehler: ' + error.message;
            }
        }

        function logout() {
            if (confirm('M√∂chten Sie sich wirklich abmelden?')) {
                location.reload();
            }
        }

        // ============================================
        // AUTO-SAVE FUNCTIONALITY
        // ============================================
        let autoSaveInterval = null;
        let hasUnsavedChanges = false;

        function onJSONChange() {
            hasUnsavedChanges = true;
            // Show unsaved changes indicator (optional visual feedback)
            const saveButton = document.querySelector('button[onclick="saveJSON()"]');
            if (saveButton && hasUnsavedChanges) {
                saveButton.classList.add('ring-4', 'ring-yellow-300');
            }
        }

        function toggleAutoSave() {
            const checkbox = document.getElementById('autoSaveToggle');
            const statusDiv = document.getElementById('autoSaveStatus');

            if (checkbox.checked) {
                statusDiv.classList.remove('hidden');
                autoSaveInterval = setInterval(() => {
                    if (hasUnsavedChanges) {
                        console.log('Auto-Speichern wird ausgef√ºhrt...');
                        saveJSON(true); // true = auto-save mode (no confirmation)
                    }
                }, 30000); // 30 seconds
            } else {
                statusDiv.classList.add('hidden');
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }
            }
        }

        // ============================================
        // PERMISSION-BASED EDITING
        // ============================================
        function canEditWohnung(wohnung) {
            // Check if user is Ausschuss member
            if (kontakteData.ausschuss && kontakteData.ausschuss.some(a => a.email === currentEmail)) {
                return true; // Ausschuss can edit all
            }

            // Check if user is the Eigent√ºmer of this Wohnung
            if (wohnung.eigent√ºmer && wohnung.eigent√ºmer.email === currentEmail) {
                return true;
            }

            // Check if user is the berechtigter Mieter of this Wohnung
            if (wohnung.mieter && wohnung.mieter.berechtigt && wohnung.mieter.email === currentEmail) {
                return true;
            }

            return false;
        }

        // Funktion zum Vergleichen von Verteilerlisten
        function compareVerteilerListen(oldLists, newLists) {
            if (!oldLists) return null; // Keine alten Listen vorhanden

            const changes = {
                hasChanges: false,
                details: []
            };

            const listTypes = ['eigentuemer', 'ausschuss', 'bewohner', 'alle'];

            listTypes.forEach(type => {
                const oldList = oldLists[type] || [];
                const newList = newLists[type] || [];

                // Vergleiche E-Mail-Listen
                const oldEmails = oldList.map(m => m.email).sort();
                const newEmails = newList.map(m => m.email).sort();

                // Finde Unterschiede
                const added = newEmails.filter(e => !oldEmails.includes(e));
                const removed = oldEmails.filter(e => !newEmails.includes(e));

                if (added.length > 0 || removed.length > 0) {
                    changes.hasChanges = true;
                    changes.details.push({
                        type: type,
                        oldCount: oldList.length,
                        newCount: newList.length,
                        added: added,
                        removed: removed
                    });
                }
            });

            return changes;
        }

        // Funktion zum Senden von Verteilerlisten-√Ñnderungsbenachrichtigungen
        async function sendVerteilerListenNotification(changes) {
            if (!changes || !changes.hasChanges) return;

            try {
                // Hole Ausschuss-E-Mails
                const ausschussEmails = kontakteData.ausschuss.map(m => m.email);

                console.log('Sende Verteilerlisten-√Ñnderungsbenachrichtigung an Ausschuss:', ausschussEmails);

                // Generiere HTML
                const htmlContent = generateVerteilerChangeHTML({
                    changes: changes.details,
                    changedBy: currentEmail,
                    timestamp: new Date().toISOString(),
                    stwegNummer: kontakteData.stweg?.nummer || 3,
                    stwegAdresse: kontakteData.stweg?.adresse || 'Rosenweg 9',
                    stwegOrt: `${kontakteData.stweg?.plz || '4303'} ${kontakteData.stweg?.ort || 'Kaiseraugst'}`
                });

                // Sende E-Mail an alle Ausschussmitglieder
                const success = await sendEmail(
                    ausschussEmails,
                    `STWEG ${kontakteData.stweg?.nummer || 3}: Verteilerlisten aktualisiert`,
                    htmlContent
                );

                if (success) {
                    console.log('‚úÖ Verteilerlisten-√Ñnderungsbenachrichtigung erfolgreich gesendet');
                }
            } catch (error) {
                console.error('Fehler beim Senden der Verteilerlisten-Benachrichtigung:', error);
            }
        }

        // Funktion zum Generieren der Verteilerlisten
        function generateVerteilerListen(data) {
            const lists = {};

            // Eigent√ºmer-Liste
            lists.eigentuemer = [];
            ['erdgeschoss', 'obergeschoss_1', 'obergeschoss_2'].forEach(etage => {
                data.wohnungen[etage].forEach(wohnung => {
                    if (wohnung.eigent√ºmer) {
                        lists.eigentuemer.push({
                            name: wohnung.eigent√ºmer.name,
                            email: wohnung.eigent√ºmer.email,
                            wohnung: wohnung.bezeichnung
                        });
                    }
                });
            });

            // Ausschuss-Liste
            lists.ausschuss = data.ausschuss.map(vertreter => ({
                name: vertreter.name,
                email: vertreter.email,
                funktion: vertreter.funktion,
                wohnung: vertreter.wohnung
            }));

            // Bewohner-Liste (Mieter + Eigent√ºmer ohne Mieter)
            lists.bewohner = [];
            ['erdgeschoss', 'obergeschoss_1', 'obergeschoss_2'].forEach(etage => {
                data.wohnungen[etage].forEach(wohnung => {
                    // Wenn es einen Mieter gibt, nimm den Mieter
                    if (wohnung.mieter) {
                        lists.bewohner.push({
                            name: wohnung.mieter.name,
                            email: wohnung.mieter.email,
                            wohnung: wohnung.bezeichnung
                        });
                    }
                    // Wenn kein Mieter, nimm den Eigent√ºmer
                    else if (wohnung.eigent√ºmer) {
                        lists.bewohner.push({
                            name: wohnung.eigent√ºmer.name,
                            email: wohnung.eigent√ºmer.email,
                            wohnung: wohnung.bezeichnung
                        });
                    }
                });
            });

            // Alle Bewohner (Eigent√ºmer + berechtigte Mieter)
            lists.alle = [...lists.eigentuemer];
            ['erdgeschoss', 'obergeschoss_1', 'obergeschoss_2'].forEach(etage => {
                data.wohnungen[etage].forEach(wohnung => {
                    if (wohnung.mieter && wohnung.mieter.berechtigt) {
                        lists.alle.push({
                            name: wohnung.mieter.name,
                            email: wohnung.mieter.email,
                            wohnung: wohnung.bezeichnung
                        });
                    }
                });
            });

            return lists;
        }

        // Modified saveJSON to accept auto-save parameter
        async function saveJSON(autoSave = false) {
            const jsonText = document.getElementById('jsonEditor').value;

            // Validierung
            try {
                const parsed = JSON.parse(jsonText);
                kontakteData = parsed;
            } catch (error) {
                if (!autoSave) {
                    document.getElementById('jsonError').classList.remove('hidden');
                    document.getElementById('jsonError').querySelector('p').textContent =
                        'JSON-Fehler: ' + error.message + '. Bitte korrigieren Sie den Fehler vor dem Speichern.';
                }
                return;
            }

            // Verteilerlisten automatisch generieren und √Ñnderungen verfolgen
            const oldVerteilerlisten = kontakteData.verteilerlisten;
            const newVerteilerlisten = generateVerteilerListen(kontakteData);
            kontakteData.verteilerlisten = newVerteilerlisten;
            console.log('Verteilerlisten generiert:', kontakteData.verteilerlisten);

            // Pr√ºfe auf Verteilerlisten-√Ñnderungen
            const verteilerChanges = compareVerteilerListen(oldVerteilerlisten, newVerteilerlisten);
            if (verteilerChanges && verteilerChanges.hasChanges) {
                console.log('Verteilerlisten-√Ñnderungen erkannt:', verteilerChanges);
                await sendVerteilerListenNotification(verteilerChanges);
            }

            // JSON-Editor mit den aktualisierten Daten aktualisieren
            document.getElementById('jsonEditor').value = JSON.stringify(kontakteData, null, 2);

            // Sicherheitsabfrage (skip for auto-save)
            if (!autoSave && !confirm('M√∂chten Sie die √Ñnderungen wirklich speichern? Diese werden sofort f√ºr alle Nutzer sichtbar.')) {
                return;
            }

            try {
                const response = await fetch(N8N_SAVE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: currentEmail,
                        data: kontakteData
                    })
                });

                if (!response.ok) {
                    throw new Error('Speichern fehlgeschlagen');
                }

                // Clear unsaved changes flag
                hasUnsavedChanges = false;

                // Remove visual indicator from save button
                const saveButton = document.querySelector('button[onclick="saveJSON()"]');
                if (saveButton) {
                    saveButton.classList.remove('ring-4', 'ring-yellow-300');
                }

                document.getElementById('jsonError').classList.add('hidden');
                document.getElementById('jsonSuccess').classList.remove('hidden');
                document.getElementById('jsonSuccess').querySelector('p').textContent =
                    autoSave ? '‚úì Auto-Speichern erfolgreich!' : 'JSON erfolgreich gespeichert! ‚úì';

                // Wohnungsliste neu laden
                loadWohnungList();

                // Hide success message after 3 seconds
                setTimeout(() => {
                    document.getElementById('jsonSuccess').classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                if (!autoSave) {
                    document.getElementById('jsonError').classList.remove('hidden');
                    document.getElementById('jsonError').querySelector('p').textContent =
                        'Fehler beim Speichern: ' + error.message +
                        '. Hinweis: Das Speichern erfordert einen Backend-Endpunkt (n8n Workflow).';
                }
            }
        }
    </script>
</body>
</html>
