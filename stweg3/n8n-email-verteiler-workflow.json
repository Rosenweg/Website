{
  "name": "STWEG3 - E-Mail Verteiler",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "stweg3-email-verteiler",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook - E-Mail Verteiler",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "stweg3-email-verteiler"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.body.verteiler }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            },
            {
              "leftValue": "={{ $json.body.subject }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            },
            {
              "leftValue": "={{ $json.body.message }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            },
            {
              "leftValue": "={{ $json.body.sender_email }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "validate-input",
      "name": "Validate Input",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "url": "https://rosenweg.github.io/Website/stweg3/verteiler.json",
        "options": {}
      },
      "id": "fetch-verteiler",
      "name": "Fetch verteiler.json",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 200]
    },
    {
      "parameters": {
        "url": "https://rosenweg.github.io/Website/stweg3/kontakte.json",
        "options": {}
      },
      "id": "fetch-kontakte",
      "name": "Fetch kontakte.json",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "jsCode": "// KONFIGURATION\nconst ALLOWED_VERTEILER = ['eigentuemer', 'ausschuss', 'bewohner', 'alle'];\n\n// Input aus Webhook\nconst webhookData = $input.first().json.body;\nconst verteilerId = webhookData.verteiler;\nconst subject = webhookData.subject;\nconst message = webhookData.message;\nconst senderEmail = webhookData.sender_email;\nconst senderName = webhookData.sender_name || senderEmail;\n\n// Verteiler.json aus HTTP Request\nconst verteilerData = $('Fetch verteiler.json').first().json;\n\n// Kontakte.json aus HTTP Request\nconst kontakteData = $('Fetch kontakte.json').first().json;\n\n// PrÃ¼fe ob Verteiler existiert\nif (!ALLOWED_VERTEILER.includes(verteilerId)) {\n  throw new Error(`UngÃ¼ltiger Verteiler: ${verteilerId}. Erlaubt: ${ALLOWED_VERTEILER.join(', ')}`);\n}\n\n// Finde den Verteiler\nconst verteiler = verteilerData.verteiler.find(v => v.id === verteilerId);\nif (!verteiler) {\n  throw new Error(`Verteiler ${verteilerId} nicht gefunden`);\n}\n\n// Funktion: Alle E-Mails fÃ¼r einen Verteiler sammeln\nfunction getVerteilerEmails(verteilerId, kontakteData) {\n  const emails = [];\n  \n  if (verteilerId === 'eigentuemer') {\n    // Alle EigentÃ¼mer\n    ['erdgeschoss', 'obergeschoss_1', 'obergeschoss_2'].forEach(etage => {\n      if (kontakteData.wohnungen && kontakteData.wohnungen[etage]) {\n        kontakteData.wohnungen[etage].forEach(wohnung => {\n          if (wohnung.eigentÃ¼mer && wohnung.eigentÃ¼mer.email) {\n            emails.push({\n              email: wohnung.eigentÃ¼mer.email,\n              name: wohnung.eigentÃ¼mer.name,\n              wohnung: wohnung.bezeichnung\n            });\n          }\n        });\n      }\n    });\n  } else if (verteilerId === 'ausschuss') {\n    // Alle Ausschussmitglieder\n    if (kontakteData.ausschuss) {\n      kontakteData.ausschuss.forEach(mitglied => {\n        if (mitglied.email) {\n          // E-Mails kÃ¶nnen kommagetrennt sein\n          const emailArray = mitglied.email.split(',');\n          emailArray.forEach(email => {\n            const trimmed = email.trim();\n            if (trimmed && trimmed.includes('@')) {\n              emails.push({\n                email: trimmed,\n                name: mitglied.name,\n                rolle: mitglied.rolle\n              });\n            }\n          });\n        }\n      });\n    }\n  } else if (verteilerId === 'bewohner') {\n    // Alle Mieter + EigentÃ¼mer von Wohnungen ohne Mieter\n    ['erdgeschoss', 'obergeschoss_1', 'obergeschoss_2'].forEach(etage => {\n      if (kontakteData.wohnungen && kontakteData.wohnungen[etage]) {\n        kontakteData.wohnungen[etage].forEach(wohnung => {\n          if (wohnung.mieter && wohnung.mieter.email) {\n            // Wenn Mieter vorhanden: Nur Mieter hinzufÃ¼gen\n            emails.push({\n              email: wohnung.mieter.email,\n              name: wohnung.mieter.name,\n              wohnung: wohnung.bezeichnung,\n              rolle: 'Mieter'\n            });\n          } else if (wohnung.eigentÃ¼mer && wohnung.eigentÃ¼mer.email) {\n            // Wenn KEIN Mieter: EigentÃ¼mer hinzufÃ¼gen\n            emails.push({\n              email: wohnung.eigentÃ¼mer.email,\n              name: wohnung.eigentÃ¼mer.name,\n              wohnung: wohnung.bezeichnung,\n              rolle: 'EigentÃ¼mer'\n            });\n          }\n        });\n      }\n    });\n  } else if (verteilerId === 'alle') {\n    // Alle EigentÃ¼mer + ALLE Mieter (egal ob berechtigt oder nicht)\n    ['erdgeschoss', 'obergeschoss_1', 'obergeschoss_2'].forEach(etage => {\n      if (kontakteData.wohnungen && kontakteData.wohnungen[etage]) {\n        kontakteData.wohnungen[etage].forEach(wohnung => {\n          // EigentÃ¼mer\n          if (wohnung.eigentÃ¼mer && wohnung.eigentÃ¼mer.email) {\n            emails.push({\n              email: wohnung.eigentÃ¼mer.email,\n              name: wohnung.eigentÃ¼mer.name,\n              wohnung: wohnung.bezeichnung,\n              rolle: 'EigentÃ¼mer'\n            });\n          }\n          // ALLE Mieter (egal ob berechtigt oder nicht)\n          if (wohnung.mieter && wohnung.mieter.email) {\n            emails.push({\n              email: wohnung.mieter.email,\n              name: wohnung.mieter.name,\n              wohnung: wohnung.bezeichnung,\n              rolle: 'Mieter'\n            });\n          }\n        });\n      }\n    });\n  }\n  \n  // Duplikate entfernen (basierend auf E-Mail)\n  const uniqueEmails = [];\n  const seen = new Set();\n  emails.forEach(entry => {\n    const emailLower = entry.email.toLowerCase();\n    if (!seen.has(emailLower)) {\n      seen.add(emailLower);\n      uniqueEmails.push(entry);\n    }\n  });\n  \n  return uniqueEmails;\n}\n\n// E-Mails sammeln\nconst recipients = getVerteilerEmails(verteilerId, kontakteData);\n\nif (recipients.length === 0) {\n  throw new Error(`Keine EmpfÃ¤nger fÃ¼r Verteiler ${verteilerId} gefunden`);\n}\n\n// Output fÃ¼r jeden EmpfÃ¤nger\nreturn recipients.map(recipient => ({\n  json: {\n    recipientEmail: recipient.email,\n    recipientName: recipient.name,\n    subject: subject,\n    message: message,\n    senderEmail: senderEmail,\n    senderName: senderName,\n    verteilerName: verteiler.name,\n    verteilerId: verteilerId,\n    wohnung: recipient.wohnung || null,\n    rolle: recipient.rolle || null\n  }\n}));"
      },
      "id": "process-verteiler",
      "name": "Process Verteiler",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "fromEmail": "noreply@juroct.net",
        "toEmail": "={{ $json.recipientEmail }}",
        "subject": "={{ $json.subject }}",
        "emailType": "html",
        "text": "=<html>\n<head>\n  <style>\n    body { font-family: 'Arial', sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }\n    .container { max-width: 600px; margin: 0 auto; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }\n    .header { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; padding: 30px; text-align: center; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .content { padding: 30px; }\n    .info-box { background-color: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 20px 0; border-radius: 4px; }\n    .message-box { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; margin: 20px 0; border-radius: 8px; white-space: pre-wrap; }\n    .footer { background-color: #f9fafb; padding: 20px; text-align: center; color: #6b7280; font-size: 12px; }\n    .sender-info { color: #6b7280; font-size: 14px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>ðŸ“§ " + $json.verteilerName + "</h1>\n      <p>STWEG 3 - Rosenweg 9</p>\n    </div>\n    <div class=\"content\">\n      <p>Hallo " + ($json.recipientName || 'Bewohner/in') + ",</p>\n      \n      <div class=\"info-box\">\n        <p style=\"margin: 0;\"><strong>ðŸ“¨ Nachricht Ã¼ber:</strong> " + $json.verteilerName + "</p>\n      </div>\n      \n      <div class=\"message-box\">" + $json.message + "</div>\n      \n      <div class=\"sender-info\">\n        <p style=\"margin: 0;\"><strong>Gesendet von:</strong> " + $json.senderName + "</p>\n        <p style=\"margin: 5px 0 0 0; font-size: 12px;\">E-Mail: " + $json.senderEmail + "</p>\n      </div>\n      \n      <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n      \n      <p style=\"font-size: 12px; color: #6b7280;\">\n        <strong>Hinweis:</strong> Diese E-Mail wurde Ã¼ber das STWEG 3 Verteiler-System versendet. Bei Fragen wenden Sie sich bitte an den Absender.\n      </p>\n    </div>\n    <div class=\"footer\">\n      <p>Â© 2025 STWEG 3 - Rosenweg 9, 4303 Kaiseraugst</p>\n      <p>Teil der STWEG-Kooperation Rosenweg</p>\n    </div>\n  </div>\n</body>\n</html>"
      },
      "id": "send-email",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, message: 'E-Mail wurde an ' + $('Process Verteiler').itemMatching(0).json.verteilerName + ' versendet', recipients_count: $('Send Email').itemMatching(0).json ? $('Send Email').all().length : 0, verteiler: $('Process Verteiler').itemMatching(0).json.verteilerId } }}"
      },
      "id": "success-response",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseCode": 400,
        "responseBody": "={{ { success: false, error: 'UngÃ¼ltige Anfrage. Erforderlich: verteiler, subject, message, sender_email' } }}"
      },
      "id": "error-response-validation",
      "name": "Error Response - Validation",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [680, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseCode": 500,
        "responseBody": "={{ { success: false, error: 'Fehler beim Verarbeiten: ' + $json.error } }}"
      },
      "id": "error-response-processing",
      "name": "Error Response - Processing",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1120, 500]
    }
  ],
  "connections": {
    "Webhook - E-Mail Verteiler": {
      "main": [
        [
          {
            "node": "Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Input": {
      "main": [
        [
          {
            "node": "Fetch verteiler.json",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch kontakte.json",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response - Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch verteiler.json": {
      "main": [
        [
          {
            "node": "Process Verteiler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch kontakte.json": {
      "main": [
        [
          {
            "node": "Process Verteiler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Verteiler": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "STWEG3",
      "id": "1"
    },
    {
      "name": "Email",
      "id": "2"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-11-04T12:00:00.000Z",
  "versionId": "1"
}
