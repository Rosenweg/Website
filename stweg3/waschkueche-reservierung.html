<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waschk√ºchen Reservierung - STWEG 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .time-slot {
            transition: all 0.2s;
        }
        .time-slot:hover:not(.booked) {
            transform: scale(1.02);
        }
        .time-slot.available {
            cursor: pointer;
        }
        .time-slot.booked {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center">
                        <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        <span class="ml-2 text-xl font-semibold text-gray-800">Waschk√ºchen Reservierung</span>
                    </a>
                </div>
                <div class="flex items-center">
                    <a href="index.html#waschkueche" class="text-gray-700 hover:text-green-600 transition">‚Üê Zur√ºck</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <section class="bg-gradient-to-r from-green-600 to-green-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-2">üß∫ Waschk√ºchen Reservierung</h1>
                <p class="text-xl opacity-90">STWEG 3 - Rosenweg 9</p>
                <p class="text-lg opacity-80 mt-2">Sicheres Online-Reservierungssystem mit OTP-Authentifizierung</p>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- OTP Login Section (shown initially) -->
        <div id="otp-login-section" class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="text-center mb-6">
                    <div class="bg-green-100 rounded-full p-4 inline-block mb-4">
                        <svg class="h-12 w-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Anmeldung erforderlich</h2>
                    <p class="text-gray-600">Bitte geben Sie Ihre E-Mail-Adresse ein, um einen Zugangscode zu erhalten.</p>
                </div>

                <!-- Step 1: Email Input -->
                <div id="email-step" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail-Adresse</label>
                        <input type="email" id="email-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="ihre@email.ch">
                    </div>
                    <button id="request-otp-btn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                        Code anfordern
                    </button>
                    <div id="email-error" class="hidden text-red-600 text-sm text-center"></div>
                </div>

                <!-- Step 2: OTP Input -->
                <div id="otp-step" class="hidden space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <p class="text-sm text-blue-800">
                            Ein 6-stelliger Code wurde an <strong id="email-display"></strong> gesendet.
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">6-stelliger Code</label>
                        <input type="text" id="otp-input" maxlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl font-mono tracking-widest focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="000000">
                    </div>
                    <button id="verify-otp-btn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                        Code best√§tigen
                    </button>
                    <button id="back-to-email-btn" class="w-full text-gray-600 hover:text-gray-800 transition text-sm">
                        ‚Üê Andere E-Mail verwenden
                    </button>
                    <div id="otp-error" class="hidden text-red-600 text-sm text-center"></div>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden text-center py-4">
                    <svg class="animate-spin h-8 w-8 text-green-600 mx-auto" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-600 mt-2">Bitte warten...</p>
                </div>
            </div>

            <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <p class="text-sm text-gray-700">
                    <strong>üí° Hinweis:</strong> Der Zugangscode ist 10 Minuten g√ºltig. Nur registrierte E-Mail-Adressen der STWEG 3 haben Zugriff.
                </p>
            </div>
        </div>

        <!-- Reservation System (shown after OTP verification) -->
        <div id="reservation-section" class="hidden">
            <!-- User Info & Logout -->
            <div class="bg-white rounded-lg shadow p-4 mb-6 flex justify-between items-center">
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-gray-700">Angemeldet als: <strong id="logged-email"></strong></span>
                </div>
                <button id="logout-btn" class="text-red-600 hover:text-red-700 text-sm font-semibold">
                    Abmelden
                </button>
            </div>

            <!-- Date Selector -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Datum w√§hlen</h2>
                <div class="grid grid-cols-2 md:grid-cols-7 gap-2">
                    <!-- Will be populated by JavaScript -->
                    <div id="date-selector" class="contents"></div>
                </div>
                <div class="mt-4 flex items-center justify-between">
                    <button id="prev-week-btn" class="text-green-600 hover:text-green-700 font-semibold">
                        ‚Üê Vorherige Woche
                    </button>
                    <span id="week-display" class="text-gray-600 text-sm"></span>
                    <button id="next-week-btn" class="text-green-600 hover:text-green-700 font-semibold">
                        N√§chste Woche ‚Üí
                    </button>
                </div>
            </div>

            <!-- Waschk√ºche Selection -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <button id="select-wk1" class="waschkueche-btn bg-white hover:bg-green-50 border-2 border-gray-200 rounded-lg p-6 text-left transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">Waschk√ºche 1</h3>
                            <p class="text-sm text-gray-600">Untergeschoss</p>
                        </div>
                        <span class="bg-green-100 text-green-800 w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">1</span>
                    </div>
                </button>
                <button id="select-wk2" class="waschkueche-btn bg-white hover:bg-green-50 border-2 border-gray-200 rounded-lg p-6 text-left transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">Waschk√ºche 2</h3>
                            <p class="text-sm text-gray-600">Untergeschoss</p>
                        </div>
                        <span class="bg-green-100 text-green-800 w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">2</span>
                    </div>
                </button>
            </div>

            <!-- Time Slots -->
            <div id="timeslots-section" class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        Verf√ºgbare Zeitfenster f√ºr <span id="selected-wk-display">Waschk√ºche 1</span>
                    </h2>
                    <span class="text-sm text-gray-600" id="selected-date-display">W√§hlen Sie ein Datum</span>
                </div>

                <div class="mb-4 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <p class="text-sm text-blue-800">
                        <strong>‚ÑπÔ∏è Hinweis:</strong> Reservierungen sind t√§glich von 07:00 - 20:00 Uhr m√∂glich (au√üer Sonntags). Jedes Zeitfenster dauert 3 Stunden.
                    </p>
                </div>

                <div id="timeslots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- My Reservations -->
            <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Meine Reservierungen</h2>
                <div id="my-reservations-container" class="space-y-3">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="booking-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Reservierung best√§tigen</h3>
            <div class="space-y-3 mb-6">
                <div class="flex justify-between">
                    <span class="text-gray-600">Waschk√ºche:</span>
                    <span class="font-semibold" id="modal-wk"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Datum:</span>
                    <span class="font-semibold" id="modal-date"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Zeit:</span>
                    <span class="font-semibold" id="modal-time"></span>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Name / Wohnung</label>
                <input type="text" id="booking-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="z.B. Familie M√ºller, EG.1">
            </div>
            <div class="flex gap-3">
                <button id="cancel-booking-btn" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">
                    Abbrechen
                </button>
                <button id="confirm-booking-btn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                    Best√§tigen
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-300">&copy; 2025 STWEG 3 - Rosenweg 9, 4303 Kaiseraugst</p>
            <p class="text-gray-400 text-sm mt-2">Waschk√ºchen-Reservierungssystem mit OTP-Authentifizierung</p>
        </div>
    </footer>

    <script>
        // Configuration
        const OTP_API_URL = 'https://n8n.juroct.net/webhook/stweg3-otp';
        const RESERVATION_API_URL = 'https://n8n.juroct.net/webhook/stweg3-reservations';

        // State
        let currentUser = {
            email: '',
            otpToken: '',
            authenticated: false
        };

        let currentWeekStart = new Date();
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1); // Monday

        let selectedDate = null;
        let selectedWaschkueche = 1;
        let reservations = [];

        // OTP Login Logic
        document.getElementById('request-otp-btn').addEventListener('click', requestOTP);
        document.getElementById('verify-otp-btn').addEventListener('click', verifyOTP);
        document.getElementById('back-to-email-btn').addEventListener('click', backToEmail);
        document.getElementById('logout-btn').addEventListener('click', logout);

        // Enter key support
        document.getElementById('email-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') requestOTP();
        });
        document.getElementById('otp-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyOTP();
        });

        async function requestOTP() {
            const email = document.getElementById('email-input').value.trim();
            if (!email || !email.includes('@')) {
                showError('email-error', 'Bitte geben Sie eine g√ºltige E-Mail-Adresse ein.');
                return;
            }

            showLoading(true);
            hideError('email-error');

            // Generate OTP code
            const otpCode = Math.floor(100000 + Math.random() * 900000).toString();

            try {
                const response = await fetch(OTP_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        otp_code: otpCode,
                        source: 'Waschk√ºchen Reservierung STWEG 3'
                    })
                });

                if (response.ok) {
                    // Store OTP temporarily (in real app, this would be server-side)
                    sessionStorage.setItem('pendingOTP', JSON.stringify({ email, code: otpCode, timestamp: Date.now() }));

                    document.getElementById('email-display').textContent = email;
                    document.getElementById('email-step').classList.add('hidden');
                    document.getElementById('otp-step').classList.remove('hidden');
                    document.getElementById('otp-input').focus();
                } else {
                    showError('email-error', 'E-Mail-Adresse nicht berechtigt oder Fehler beim Senden.');
                }
            } catch (error) {
                showError('email-error', 'Netzwerkfehler. Bitte versuchen Sie es erneut.');
            } finally {
                showLoading(false);
            }
        }

        function verifyOTP() {
            const enteredCode = document.getElementById('otp-input').value.trim();
            const pendingOTP = JSON.parse(sessionStorage.getItem('pendingOTP') || '{}');

            if (!enteredCode || enteredCode.length !== 6) {
                showError('otp-error', 'Bitte geben Sie einen 6-stelligen Code ein.');
                return;
            }

            // Check if OTP expired (10 minutes)
            if (Date.now() - pendingOTP.timestamp > 10 * 60 * 1000) {
                showError('otp-error', 'Code ist abgelaufen. Bitte fordern Sie einen neuen an.');
                backToEmail();
                return;
            }

            if (enteredCode === pendingOTP.code) {
                // Success!
                currentUser.email = pendingOTP.email;
                currentUser.authenticated = true;
                currentUser.otpToken = generateToken();

                sessionStorage.setItem('authUser', JSON.stringify(currentUser));
                sessionStorage.removeItem('pendingOTP');

                showReservationSystem();
            } else {
                showError('otp-error', 'Ung√ºltiger Code. Bitte versuchen Sie es erneut.');
            }
        }

        function backToEmail() {
            document.getElementById('otp-step').classList.add('hidden');
            document.getElementById('email-step').classList.remove('hidden');
            document.getElementById('otp-input').value = '';
            hideError('otp-error');
        }

        function logout() {
            currentUser = { email: '', otpToken: '', authenticated: false };
            sessionStorage.removeItem('authUser');
            document.getElementById('reservation-section').classList.add('hidden');
            document.getElementById('otp-login-section').classList.remove('hidden');
            backToEmail();
        }

        function showReservationSystem() {
            document.getElementById('otp-login-section').classList.add('hidden');
            document.getElementById('reservation-section').classList.remove('hidden');
            document.getElementById('logged-email').textContent = currentUser.email;

            loadReservations();
            renderDateSelector();
            renderTimeSlots();
        }

        function generateToken() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        function showLoading(show) {
            document.getElementById('loading-state').classList.toggle('hidden', !show);
            document.getElementById('email-step').classList.toggle('hidden', show);
            document.getElementById('otp-step').classList.toggle('hidden', show);
        }

        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Check if already authenticated
        const savedUser = JSON.parse(sessionStorage.getItem('authUser') || '{}');
        if (savedUser.authenticated) {
            currentUser = savedUser;
            showReservationSystem();
        }

        // Reservation System Logic
        document.getElementById('prev-week-btn').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderDateSelector();
        });

        document.getElementById('next-week-btn').addEventListener('click', () => {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderDateSelector();
        });

        document.getElementById('select-wk1').addEventListener('click', () => selectWaschkueche(1));
        document.getElementById('select-wk2').addEventListener('click', () => selectWaschkueche(2));

        function selectWaschkueche(num) {
            selectedWaschkueche = num;
            document.querySelectorAll('.waschkueche-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'bg-green-50');
                btn.classList.add('border-gray-200');
            });
            document.getElementById(`select-wk${num}`).classList.add('border-green-500', 'bg-green-50');
            document.getElementById('selected-wk-display').textContent = `Waschk√ºche ${num}`;
            renderTimeSlots();
        }

        function renderDateSelector() {
            const container = document.getElementById('date-selector');
            container.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);

                const dateStr = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('de-DE', { weekday: 'short' });
                const dayNum = date.getDate();
                const monthName = date.toLocaleDateString('de-DE', { month: 'short' });

                const isToday = date.getTime() === today.getTime();
                const isPast = date < today;
                const isSunday = date.getDay() === 0;
                const isSelected = selectedDate === dateStr;

                const button = document.createElement('button');
                button.className = `p-3 rounded-lg border-2 transition ${
                    isPast || isSunday ? 'bg-gray-100 border-gray-200 cursor-not-allowed opacity-50' :
                    isSelected ? 'bg-green-600 text-white border-green-600' :
                    isToday ? 'bg-blue-50 border-blue-500 hover:bg-blue-100' :
                    'bg-white border-gray-200 hover:border-green-500 hover:bg-green-50'
                }`;
                button.innerHTML = `
                    <div class="text-xs font-semibold ${isSelected ? 'text-white' : 'text-gray-600'}">${dayName}</div>
                    <div class="text-2xl font-bold ${isSelected ? 'text-white' : 'text-gray-800'}">${dayNum}</div>
                    <div class="text-xs ${isSelected ? 'text-white' : 'text-gray-500'}">${monthName}</div>
                    ${isSunday ? '<div class="text-xs text-red-600 mt-1">Geschl.</div>' : ''}
                `;

                if (!isPast && !isSunday) {
                    button.addEventListener('click', () => {
                        selectedDate = dateStr;
                        renderDateSelector();
                        renderTimeSlots();
                    });
                }

                container.appendChild(button);
            }

            const weekStart = currentWeekStart.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const weekEndStr = weekEnd.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            document.getElementById('week-display').textContent = `${weekStart} - ${weekEndStr}`;
        }

        function renderTimeSlots() {
            const container = document.getElementById('timeslots-container');

            if (!selectedDate) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Bitte w√§hlen Sie ein Datum aus.</div>';
                document.getElementById('selected-date-display').textContent = 'W√§hlen Sie ein Datum';
                return;
            }

            const dateObj = new Date(selectedDate + 'T00:00:00');
            document.getElementById('selected-date-display').textContent = dateObj.toLocaleDateString('de-DE', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            container.innerHTML = '';

            const slots = [
                { start: '07:00', end: '10:00' },
                { start: '10:00', end: '13:00' },
                { start: '13:00', end: '16:00' },
                { start: '16:00', end: '19:00' },
                { start: '19:00', end: '22:00' }
            ];

            slots.forEach(slot => {
                const reservation = reservations.find(r =>
                    r.date === selectedDate &&
                    r.waschkueche === selectedWaschkueche &&
                    r.startTime === slot.start
                );

                const isBooked = !!reservation;
                const isMyBooking = isBooked && reservation.email === currentUser.email;

                const div = document.createElement('div');
                div.className = `time-slot p-4 rounded-lg border-2 ${
                    isBooked ?
                        (isMyBooking ? 'bg-blue-50 border-blue-500 booked' : 'bg-gray-100 border-gray-300 booked') :
                        'bg-white border-green-300 hover:border-green-500 hover:bg-green-50 available'
                }`;

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-lg font-bold ${isBooked ? 'text-gray-600' : 'text-green-700'}">${slot.start} - ${slot.end}</div>
                        ${isBooked ?
                            `<span class="text-xs px-2 py-1 rounded ${isMyBooking ? 'bg-blue-200 text-blue-800' : 'bg-red-200 text-red-800'}">${isMyBooking ? 'Meine' : 'Belegt'}</span>` :
                            '<span class="text-xs px-2 py-1 rounded bg-green-200 text-green-800">Frei</span>'
                        }
                    </div>
                    ${isBooked ?
                        `<div class="text-sm text-gray-600">${reservation.name || 'Reserviert'}</div>
                         ${isMyBooking ? '<button class="mt-2 text-xs text-red-600 hover:text-red-700 font-semibold cancel-my-booking">Stornieren</button>' : ''}` :
                        '<div class="text-sm text-gray-500">Verf√ºgbar</div>'
                    }
                `;

                if (!isBooked) {
                    div.addEventListener('click', () => openBookingModal(slot));
                }

                if (isMyBooking) {
                    const cancelBtn = div.querySelector('.cancel-my-booking');
                    cancelBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        cancelReservation(reservation.id);
                    });
                }

                container.appendChild(div);
            });
        }

        function openBookingModal(slot) {
            const dateObj = new Date(selectedDate + 'T00:00:00');
            document.getElementById('modal-wk').textContent = `Waschk√ºche ${selectedWaschkueche}`;
            document.getElementById('modal-date').textContent = dateObj.toLocaleDateString('de-DE', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('modal-time').textContent = `${slot.start} - ${slot.end}`;

            document.getElementById('booking-modal').classList.remove('hidden');
            document.getElementById('booking-name').value = '';
            document.getElementById('booking-name').focus();

            document.getElementById('confirm-booking-btn').onclick = () => confirmBooking(slot);
        }

        document.getElementById('cancel-booking-btn').addEventListener('click', () => {
            document.getElementById('booking-modal').classList.add('hidden');
        });

        async function confirmBooking(slot) {
            const name = document.getElementById('booking-name').value.trim();
            if (!name) {
                alert('Bitte geben Sie Ihren Namen oder Ihre Wohnungsnummer ein.');
                return;
            }

            const reservation = {
                id: generateToken(),
                waschkueche: selectedWaschkueche,
                date: selectedDate,
                startTime: slot.start,
                endTime: slot.end,
                name: name,
                email: currentUser.email,
                createdAt: new Date().toISOString()
            };

            try {
                // In production, this would be an API call
                await saveReservation(reservation);
                reservations.push(reservation);

                document.getElementById('booking-modal').classList.add('hidden');
                renderTimeSlots();
                renderMyReservations();

                alert('‚úì Reservierung erfolgreich erstellt!');
            } catch (error) {
                alert('‚ùå Fehler beim Erstellen der Reservierung. Bitte versuchen Sie es erneut.');
            }
        }

        async function cancelReservation(id) {
            if (!confirm('M√∂chten Sie diese Reservierung wirklich stornieren?')) {
                return;
            }

            try {
                await deleteReservation(id);
                reservations = reservations.filter(r => r.id !== id);
                renderTimeSlots();
                renderMyReservations();
                alert('‚úì Reservierung wurde storniert.');
            } catch (error) {
                alert('‚ùå Fehler beim Stornieren. Bitte versuchen Sie es erneut.');
            }
        }

        function renderMyReservations() {
            const container = document.getElementById('my-reservations-container');
            const myReservations = reservations
                .filter(r => r.email === currentUser.email)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (myReservations.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">Keine Reservierungen vorhanden.</div>';
                return;
            }

            container.innerHTML = myReservations.map(r => {
                const dateObj = new Date(r.date + 'T00:00:00');
                const isPast = dateObj < new Date();

                return `
                    <div class="flex justify-between items-center p-4 border rounded-lg ${isPast ? 'bg-gray-50 opacity-60' : 'bg-green-50'}">
                        <div>
                            <div class="font-semibold text-gray-800">Waschk√ºche ${r.waschkueche}</div>
                            <div class="text-sm text-gray-600">
                                ${dateObj.toLocaleDateString('de-DE', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                                ‚Ä¢ ${r.startTime} - ${r.endTime}
                            </div>
                        </div>
                        ${!isPast ? `<button class="text-red-600 hover:text-red-700 text-sm font-semibold" onclick="cancelReservation('${r.id}')">Stornieren</button>` : '<span class="text-xs text-gray-500">Abgelaufen</span>'}
                    </div>
                `;
            }).join('');
        }

        // API functions (mock - replace with real API calls)
        async function loadReservations() {
            // Mock data - in production, fetch from backend
            const savedReservations = localStorage.getItem('reservations');
            reservations = savedReservations ? JSON.parse(savedReservations) : [];
            renderMyReservations();
        }

        async function saveReservation(reservation) {
            // Mock - in production, POST to backend
            const allReservations = localStorage.getItem('reservations');
            const current = allReservations ? JSON.parse(allReservations) : [];
            current.push(reservation);
            localStorage.setItem('reservations', JSON.stringify(current));
        }

        async function deleteReservation(id) {
            // Mock - in production, DELETE to backend
            const allReservations = localStorage.getItem('reservations');
            const current = allReservations ? JSON.parse(allReservations) : [];
            const updated = current.filter(r => r.id !== id);
            localStorage.setItem('reservations', JSON.stringify(updated));
        }

        // Initialize
        selectWaschkueche(1);
    </script>
</body>
</html>
