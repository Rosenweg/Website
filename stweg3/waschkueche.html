<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Waschk√ºchen - STWEG 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    <span class="ml-2 text-xl font-semibold text-gray-800">Smart Waschk√ºchen</span>
                    <span id="admin-badge" class="hidden ml-3 px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full font-semibold">
                        Ausschuss
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-email-display" class="hidden text-sm text-gray-600"></span>
                    <button id="logout-btn" class="hidden text-gray-700 hover:text-red-600 transition">
                        Abmelden
                    </button>
                    <a href="index.html" class="text-gray-700 hover:text-blue-600 transition">‚Üê Zur√ºck</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- OTP Authentication -->
    <div id="auth-section" class="min-h-screen py-12 bg-gradient-to-br from-green-50 to-green-100">
        <div class="max-w-md mx-auto px-4">
            <div class="bg-white rounded-lg shadow-xl p-8">
                <div class="text-center mb-6">
                    <div class="bg-green-100 rounded-full p-4 inline-block mb-4">
                        <svg class="h-12 w-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">üîê Zugriff sch√ºtzen</h1>
                    <p class="text-gray-600">Authentifizierung mit Ihrer E-Mail-Adresse</p>
                </div>

                <!-- Step 1: Email -->
                <div id="email-step">
                    <form id="email-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail-Adresse</label>
                            <input type="email" id="email-input" required
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                placeholder="ihre.email@example.com">
                            <p class="text-xs text-gray-500 mt-1">
                                Sie erhalten einen 6-stelligen Code per E-Mail
                            </p>
                        </div>
                        <button type="submit"
                            class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                            Code anfordern
                        </button>
                    </form>
                </div>

                <!-- Step 2: OTP -->
                <div id="otp-step" class="hidden">
                    <div class="mb-4 p-3 bg-green-50 border-l-4 border-green-500 rounded">
                        <p class="text-sm text-green-800">
                            ‚úì Code wurde an <strong id="sent-email"></strong> gesendet
                        </p>
                    </div>

                    <form id="otp-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Best√§tigungscode</label>
                            <input type="text" id="otp-input" required maxlength="6" pattern="[0-9]{6}"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-center text-2xl font-mono tracking-widest"
                                placeholder="000000">
                            <p class="text-xs text-gray-500 mt-1">Code ist 10 Minuten g√ºltig</p>
                        </div>
                        <button type="submit"
                            class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                            Best√§tigen
                        </button>
                        <button type="button" id="back-btn"
                            class="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-200 transition">
                            Zur√ºck
                        </button>
                    </form>
                </div>

                <div id="error-message" class="hidden mt-4 p-3 bg-red-50 border-l-4 border-red-500 rounded">
                    <p class="text-sm text-red-800"></p>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-xs text-gray-600">
                        <strong>üîí Datenschutz:</strong> Je nach Ihrer Berechtigung sehen Sie nur Ihre eigenen Daten
                        oder haben Zugriff auf die Verwaltungsfunktionen (Ausschuss).
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <!-- Header -->
        <section id="dashboard-header" class="bg-gradient-to-r from-green-600 to-green-800 text-white py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 id="page-title" class="text-3xl font-bold mb-2">Meine Waschk√ºchen-Daten</h1>
                        <p class="text-lg opacity-90">
                            <span id="user-name"></span>
                            <span id="user-wohnung" class="ml-2"></span>
                        </p>
                    </div>
                    <button id="refresh-btn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition">
                        üîÑ Aktualisieren
                    </button>
                </div>
            </div>
        </section>

        <!-- Tabs (nur f√ºr Admin) -->
        <div id="admin-tabs" class="hidden bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button class="tab-btn py-4 px-1 border-b-2 font-medium text-sm active" data-tab="overview">
                        √úbersicht
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 font-medium text-sm" data-tab="users">
                        Benutzer
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 font-medium text-sm" data-tab="devices">
                        Ger√§te
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 font-medium text-sm" data-tab="sessions">
                        Alle Sessions
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 font-medium text-sm" data-tab="settings">
                        Einstellungen
                    </button>
                </nav>
            </div>
        </div>

        <!-- User Stats (f√ºr alle) -->
        <section id="user-stats" class="py-8 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 id="stats-title" class="text-2xl font-bold text-gray-800 mb-6">Meine Statistiken</h2>
                <div class="grid md:grid-cols-4 gap-6" id="stats-grid">
                    <!-- Dynamisch gef√ºllt -->
                </div>
            </div>
        </section>

        <!-- Tab Contents (dynamisch basierend auf Berechtigung) -->
        <div id="dynamic-content">
            <!-- Wird dynamisch gef√ºllt basierend auf Benutzer-Rolle -->
        </div>

        <!-- Help Section -->
        <section class="py-12 bg-gray-50">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">üí° Hilfe & Informationen</h3>
                    <p class="text-gray-700 mb-3">
                        Haben Sie Fragen zur Nutzung oder Abrechnung?
                    </p>
                    <a href="waschkueche-management-info.html" class="inline-flex items-center text-blue-600 hover:underline font-semibold">
                        Zur vollst√§ndigen Dokumentation
                        <svg class="h-5 w-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">&copy; 2025 STWEG 3 - Smart Waschk√ºchen-Management</p>
            <p class="text-xs text-gray-400 mt-2">Rosenweg 9, Kaiseraugst</p>
        </div>
    </footer>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';

        // Email-basierte Berechtigungen
        const USER_EMAILS = [
            'max.mustermann@example.com',
            'anna.schmidt@example.com',
            'peter.weber@example.com',
            'maria.mueller@example.com',
            'stefan.meier@example.com'
        ];

        const ADMIN_EMAILS = [
            'stefan+rosenweg@juroct.ch',
            'fersztand.basil@teleport.ch',
            'hello@langpartners.ch'
        ];

        let currentUser = null;
        let userEmail = '';
        let isAdmin = false;

        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const mainContent = document.getElementById('main-content');
        const emailStep = document.getElementById('email-step');
        const otpStep = document.getElementById('otp-step');
        const emailForm = document.getElementById('email-form');
        const otpForm = document.getElementById('otp-form');
        const emailInput = document.getElementById('email-input');
        const otpInput = document.getElementById('otp-input');
        const errorMessage = document.getElementById('error-message');
        const sentEmail = document.getElementById('sent-email');
        const backBtn = document.getElementById('back-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const refreshBtn = document.getElementById('refresh-btn');

        // Step 1: Request OTP
        emailForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = emailInput.value.trim().toLowerCase();

            const isUser = USER_EMAILS.includes(email);
            const isAdminUser = ADMIN_EMAILS.includes(email);

            if (isUser || isAdminUser) {
                userEmail = email;
                isAdmin = isAdminUser;

                sentEmail.textContent = email;
                emailStep.classList.add('hidden');
                otpStep.classList.remove('hidden');
                showError('');

                // Demo: In Produktion w√ºrde hier ein echter OTP per E-Mail gesendet
                const role = isAdmin ? 'Administrator' : 'Benutzer';
                alert(`Demo: Ihr OTP-Code ist: 123456\n\nSie loggen sich ein als: ${role}\n\n(In Produktion wird dieser per E-Mail gesendet)`);
            } else {
                showError('Diese E-Mail-Adresse ist nicht berechtigt.');
            }
        });

        // Step 2: Verify OTP
        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const otp = otpInput.value.trim();

            if (otp === '123456') {
                showError('');

                // Admin oder normaler Benutzer?
                if (isAdmin) {
                    await loadAdminDashboard();
                } else {
                    const userId = USER_EMAILS.indexOf(userEmail) + 1;
                    await loadUserDashboard(userId);
                }

                // Show main content
                authSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                document.getElementById('user-email-display').textContent = userEmail;
                document.getElementById('user-email-display').classList.remove('hidden');
            } else {
                showError('Ung√ºltiger Code. Bitte versuchen Sie es erneut.');
            }
        });

        backBtn.addEventListener('click', () => {
            otpStep.classList.add('hidden');
            emailStep.classList.remove('hidden');
            otpInput.value = '';
            showError('');
        });

        logoutBtn.addEventListener('click', () => location.reload());
        refreshBtn.addEventListener('click', () => {
            if (isAdmin) {
                loadAdminDashboard();
            } else {
                const userId = USER_EMAILS.indexOf(userEmail) + 1;
                loadUserDashboard(userId);
            }
        });

        function showError(msg) {
            if (msg) {
                errorMessage.querySelector('p').textContent = msg;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }

        // ========================================
        // USER DASHBOARD (Normale Benutzer)
        // ========================================
        async function loadUserDashboard(userId) {
            try {
                // Get user info
                const userResponse = await fetch(`${API_BASE_URL}/users/${userId}`);
                currentUser = await userResponse.json();

                document.getElementById('page-title').textContent = 'Meine Waschk√ºchen-Daten';
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-wohnung').textContent = `‚Ä¢ ${currentUser.wohnung}`;
                document.getElementById('stats-title').textContent = 'Meine Statistiken';

                // Get stats
                const statsResponse = await fetch(`${API_BASE_URL}/users/${userId}/stats`);
                const stats = await statsResponse.json();

                // Stats Grid
                document.getElementById('stats-grid').innerHTML = `
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border-2 border-green-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Aktuelles Guthaben</h3>
                        <p class="text-3xl font-bold text-green-700">CHF ${currentUser.balance.toFixed(2)}</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border-2 border-blue-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Nutzungen gesamt</h3>
                        <p class="text-3xl font-bold text-blue-700">${stats.total.total_sessions}</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-lg border-2 border-orange-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Verbrauch gesamt</h3>
                        <p class="text-3xl font-bold text-orange-700">${stats.total.total_energy.toFixed(2)}</p>
                        <p class="text-xs text-gray-600 mt-1">kWh</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border-2 border-purple-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Kosten gesamt</h3>
                        <p class="text-3xl font-bold text-purple-700">CHF ${stats.total.total_cost.toFixed(2)}</p>
                    </div>
                `;

                // Load user sessions and transactions
                await loadUserSessions(userId);
                await loadUserTransactions(userId);

            } catch (error) {
                console.error('Error loading user dashboard:', error);
                showError('Fehler beim Laden der Daten.');
            }
        }

        async function loadUserSessions(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/sessions/user/${userId}`);
                const sessions = await response.json();

                const html = `
                    <section class="py-12 bg-gray-50">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Meine letzten Nutzungen</h2>
                            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                ${sessions.length === 0 ? '<div class="p-8 text-center text-gray-600">Noch keine Nutzungen</div>' : `
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ger√§t</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Verbrauch</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kosten</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            ${sessions.map(s => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 text-sm text-gray-900">
                                                        ${new Date(s.started_at).toLocaleString('de-CH', {
                                                            day: '2-digit', month: '2-digit', year: 'numeric',
                                                            hour: '2-digit', minute: '2-digit'
                                                        })}
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm font-medium text-gray-900">${s.device_name}</div>
                                                        <div class="text-sm text-gray-500">${s.location}</div>
                                                    </td>
                                                    <td class="px-6 py-4 text-sm text-gray-900">
                                                        ${s.energy_consumed ? s.energy_consumed.toFixed(2) + ' kWh' : '-'}
                                                    </td>
                                                    <td class="px-6 py-4 text-sm font-semibold ${s.cost ? 'text-red-600' : 'text-gray-900'}">
                                                        ${s.cost ? 'CHF ' + s.cost.toFixed(2) : '-'}
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <span class="px-2 py-1 text-xs rounded-full ${
                                                            s.status === 'completed' ? 'bg-green-100 text-green-800' :
                                                            s.status === 'active' ? 'bg-orange-100 text-orange-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }">
                                                            ${s.status === 'completed' ? 'Abgeschlossen' :
                                                              s.status === 'active' ? 'Aktiv' : s.status}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                `}
                            </div>
                        </div>
                    </section>
                `;

                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        async function loadUserTransactions(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/transactions`);
                const transactions = await response.json();

                const html = `
                    <section class="py-12 bg-white">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Transaktionen</h2>
                            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                ${transactions.length === 0 ? '<div class="p-8 text-center text-gray-600">Keine Transaktionen</div>' : `
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Beschreibung</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Typ</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Betrag</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            ${transactions.map(t => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 text-sm text-gray-900">
                                                        ${new Date(t.created_at).toLocaleString('de-CH', {
                                                            day: '2-digit', month: '2-digit', year: 'numeric'
                                                        })}
                                                    </td>
                                                    <td class="px-6 py-4 text-sm text-gray-900">${t.description}</td>
                                                    <td class="px-6 py-4">
                                                        <span class="px-2 py-1 text-xs rounded-full ${
                                                            t.transaction_type === 'topup' ? 'bg-green-100 text-green-800' :
                                                            t.transaction_type === 'usage' ? 'bg-red-100 text-red-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }">
                                                            ${t.transaction_type === 'topup' ? 'Aufladung' :
                                                              t.transaction_type === 'usage' ? 'Verbrauch' :
                                                              t.transaction_type}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 text-sm text-right font-semibold ${t.amount >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                        ${t.amount >= 0 ? '+' : ''}CHF ${Math.abs(t.amount).toFixed(2)}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                `}
                            </div>
                        </div>
                    </section>
                `;

                document.getElementById('dynamic-content').innerHTML += html;
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // ========================================
        // ADMIN DASHBOARD (Ausschuss)
        // ========================================
        async function loadAdminDashboard() {
            document.getElementById('page-title').textContent = 'Waschk√ºchen-Verwaltung (Ausschuss)';
            document.getElementById('user-name').textContent = 'Administrator';
            document.getElementById('user-wohnung').textContent = '';
            document.getElementById('admin-badge').classList.remove('hidden');
            document.getElementById('admin-tabs').classList.remove('hidden');
            document.getElementById('stats-title').textContent = 'Gesamt-Statistiken';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`);
                const stats = await response.json();

                // Admin Stats
                document.getElementById('stats-grid').innerHTML = `
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border-2 border-blue-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Aktive Benutzer</h3>
                        <p class="text-3xl font-bold text-blue-700">${stats.overview.total_users}</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border-2 border-green-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Nutzungen gesamt</h3>
                        <p class="text-3xl font-bold text-green-700">${stats.overview.total_sessions}</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-lg border-2 border-orange-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Verbrauch gesamt</h3>
                        <p class="text-3xl font-bold text-orange-700">${stats.overview.total_energy.toFixed(2)}</p>
                        <p class="text-xs text-gray-600 mt-1">kWh</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border-2 border-purple-200">
                        <h3 class="text-sm font-medium text-gray-600 mb-2">Einnahmen gesamt</h3>
                        <p class="text-3xl font-bold text-purple-700">CHF ${stats.overview.total_revenue.toFixed(2)}</p>
                    </div>
                `;

                // Show admin overview
                showAdminOverview(stats);

                // Setup tab navigation
                setupAdminTabs();

            } catch (error) {
                console.error('Error loading admin dashboard:', error);
            }
        }

        function showAdminOverview(stats) {
            const html = `
                <section class="py-12 bg-gray-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Top 5 Nutzer</h2>
                        <div class="bg-white rounded-lg shadow-md p-6">
                            ${stats.top_users.map((u, i) => `
                                <div class="flex justify-between items-center p-3 ${i === 0 ? 'bg-yellow-50' : 'bg-gray-50'} rounded mb-2">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 flex items-center justify-center bg-green-100 text-green-700 rounded-full font-bold mr-3">
                                            ${i + 1}
                                        </span>
                                        <div>
                                            <div class="font-medium">${u.name}</div>
                                            <div class="text-xs text-gray-600">${u.wohnung}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-semibold text-gray-800">${u.sessions} Nutzungen</div>
                                        <div class="text-xs text-gray-600">${u.energy.toFixed(2)} kWh ‚Ä¢ CHF ${u.spent.toFixed(2)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </section>
            `;
            document.getElementById('dynamic-content').innerHTML = html;
        }

        function setupAdminTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const tab = btn.dataset.tab;

                    // Update active tab
                    tabBtns.forEach(b => {
                        b.classList.remove('active', 'border-green-600', 'text-green-600');
                        b.classList.add('border-transparent', 'text-gray-500');
                    });
                    btn.classList.add('active', 'border-green-600', 'text-green-600');
                    btn.classList.remove('border-transparent', 'text-gray-500');

                    // Load content based on tab
                    if (tab === 'overview') {
                        const response = await fetch(`${API_BASE_URL}/admin/stats`);
                        const stats = await response.json();
                        showAdminOverview(stats);
                    } else if (tab === 'users') {
                        await loadAdminUsers();
                    } else if (tab === 'devices') {
                        await loadAdminDevices();
                    } else if (tab === 'sessions') {
                        await loadAdminSessions();
                    } else if (tab === 'settings') {
                        showAdminSettings();
                    }
                });
            });
        }

        async function loadAdminUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`);
                const users = await response.json();

                const html = `
                    <section class="py-8">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">Benutzerverwaltung</h2>
                                <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                                    + Benutzer hinzuf√ºgen
                                </button>
                            </div>
                            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wohnung</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">E-Mail</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Guthaben</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${users.map(u => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 text-sm font-medium text-gray-900">${u.name}</td>
                                                <td class="px-6 py-4 text-sm text-gray-900">${u.wohnung}</td>
                                                <td class="px-6 py-4 text-sm text-gray-600">${u.email || '-'}</td>
                                                <td class="px-6 py-4 text-sm font-semibold ${u.balance < 5 ? 'text-red-600' : 'text-green-600'}">
                                                    CHF ${u.balance.toFixed(2)}
                                                </td>
                                                <td class="px-6 py-4">
                                                    <span class="px-2 py-1 text-xs rounded-full ${u.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                        ${u.is_active ? 'Aktiv' : 'Inaktiv'}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-sm">
                                                    <button class="text-blue-600 hover:underline mr-3">Bearbeiten</button>
                                                    <button class="text-green-600 hover:underline">Aufladen</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                `;
                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading admin users:', error);
            }
        }

        async function loadAdminDevices() {
            try {
                const response = await fetch(`${API_BASE_URL}/devices`);
                const devices = await response.json();

                const html = `
                    <section class="py-8">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Ger√§te-Verwaltung</h2>
                            <div class="grid md:grid-cols-2 gap-6">
                                ${devices.map(d => `
                                    <div class="bg-white p-6 rounded-lg shadow-md border-2 ${d.is_online ? 'border-green-200' : 'border-red-200'}">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 class="text-lg font-semibold text-gray-800">${d.device_name}</h3>
                                                <p class="text-sm text-gray-600">${d.location}</p>
                                            </div>
                                            <span class="px-2 py-1 text-xs rounded-full ${d.is_online ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${d.is_online ? 'Online' : 'Offline'}
                                            </span>
                                        </div>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Status:</span>
                                                <span class="font-medium">${d.is_in_use ? 'In Benutzung' : 'Verf√ºgbar'}</span>
                                            </div>
                                            ${d.is_online ? `
                                                <div class="flex justify-between">
                                                    <span class="text-gray-600">Leistung:</span>
                                                    <span class="font-medium">${d.power?.toFixed(1) || '0'} W</span>
                                                </div>
                                            ` : ''}
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">IP:</span>
                                                <span class="font-mono text-xs">${d.shelly_ip}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </section>
                `;
                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        async function loadAdminSessions() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/sessions?limit=100`);
                const sessions = await response.json();

                const html = `
                    <section class="py-8">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">Alle Sessions</h2>
                                <button onclick="window.open('${API_BASE_URL}/admin/export/sessions', '_blank')"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                    üì• CSV Export
                                </button>
                            </div>
                            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Benutzer</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ger√§t</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Verbrauch</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kosten</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${sessions.map(s => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 text-sm text-gray-900">
                                                    ${new Date(s.started_at).toLocaleString('de-CH', {
                                                        day: '2-digit', month: '2-digit', year: 'numeric',
                                                        hour: '2-digit', minute: '2-digit'
                                                    })}
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="text-sm font-medium text-gray-900">${s.name}</div>
                                                    <div class="text-sm text-gray-500">${s.wohnung}</div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="text-sm font-medium text-gray-900">${s.device_name}</div>
                                                    <div class="text-sm text-gray-500">${s.location}</div>
                                                </td>
                                                <td class="px-6 py-4 text-sm text-gray-900">
                                                    ${s.energy_consumed ? s.energy_consumed.toFixed(2) + ' kWh' : '-'}
                                                </td>
                                                <td class="px-6 py-4 text-sm font-semibold ${s.cost ? 'text-green-600' : 'text-gray-900'}">
                                                    ${s.cost ? 'CHF ' + s.cost.toFixed(2) : '-'}
                                                </td>
                                                <td class="px-6 py-4">
                                                    <span class="px-2 py-1 text-xs rounded-full ${
                                                        s.status === 'completed' ? 'bg-green-100 text-green-800' :
                                                        s.status === 'active' ? 'bg-orange-100 text-orange-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }">
                                                        ${s.status === 'completed' ? 'Abgeschlossen' :
                                                          s.status === 'active' ? 'Aktiv' : s.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                `;
                document.getElementById('dynamic-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function showAdminSettings() {
            const html = `
                <section class="py-8">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">System-Einstellungen</h2>

                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Preiseinstellungen</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Preis pro kWh (CHF)</label>
                                    <input type="number" step="0.01" value="0.30"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <button class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                                    Speichern
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Shelly-Ger√§te</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm font-medium">Waschmaschine 1</span>
                                    <span class="text-xs text-gray-600">192.168.1.101</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm font-medium">Trockner 1</span>
                                    <span class="text-xs text-gray-600">192.168.1.102</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm font-medium">Waschmaschine 2</span>
                                    <span class="text-xs text-gray-600">192.168.1.103</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm font-medium">Trockner 2</span>
                                    <span class="text-xs text-gray-600">192.168.1.104</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            document.getElementById('dynamic-content').innerHTML = html;
        }
    </script>
</body>
</html>
